INFO [session.py]: Not running under Pytest. Loading .env for database configuration.
Database URL configured: mysql+pymysql://root:Password123!@localhost:3306/bcms_db
DEBUG [session.py]: Production/Development ASYNC_DATABASE_URL set to: mysql+aiomysql://root:Password123!@localhost:3306/bcms_db
DEBUG [session.py]: Final DATABASE_URL for sync engine: mysql+pymysql://root:Password123!@localhost:3306/bcms_db
DEBUG [session.py]: Final ASYNC_DATABASE_URL for async engine: mysql+aiomysql://root:Password123!@localhost:3306/bcms_db
Ensure your MySQL server is running and the database exists.
You might need to install pymysql: pip install pymysql
============================= test session starts ==============================
platform darwin -- Python 3.9.6, pytest-8.3.5, pluggy-1.6.0
rootdir: /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf
configfile: pytest.ini
plugins: anyio-4.9.0, asyncio-1.0.0
asyncio: mode=strict, asyncio_default_fixture_loop_scope=session, asyncio_default_test_loop_scope=function
collected 17 items

backend/app/tests/api/test_applications_api.py DEBUG [conftest.py create_test_tables]: All tables created.
DEBUG [conftest.py create_test_tables - SYNC]: Table 'people' not found.
DEBUG [conftest.py create_test_tables - SYNC]: Schema for table 'organizations':
  SYNC Column: id, Type: CHAR(32)
  SYNC Column: name, Type: VARCHAR(255)
  SYNC Column: description, Type: TEXT
  SYNC Column: industry, Type: VARCHAR(100)
  SYNC Column: isActive, Type: BOOLEAN
  SYNC Column: createdAt, Type: DATETIME
  SYNC Column: updatedAt, Type: DATETIME
DEBUG [conftest.py create_test_tables - SYNC]: Schema for table 'roles':
  SYNC Column: id, Type: CHAR(32)
  SYNC Column: name, Type: VARCHAR(50)
  SYNC Column: description, Type: TEXT
  SYNC Column: organization_id, Type: CHAR(32)
  SYNC Column: createdAt, Type: DATETIME
  SYNC Column: updatedAt, Type: DATETIME
DEBUG [conftest.py create_test_tables - SYNC]: Schema for table 'permissions':
  SYNC Column: id, Type: CHAR(32)
  SYNC Column: name, Type: VARCHAR(255)
  SYNC Column: description, Type: TEXT
  SYNC Column: createdAt, Type: DATETIME
  SYNC Column: updatedAt, Type: DATETIME
DEBUG [conftest.py create_test_tables - SYNC]: Table 'people_roles' not found.
DEBUG [conftest.py create_test_tables - SYNC]: Schema for table 'role_permissions':
  SYNC Column: role_id, Type: CHAR(32)
  SYNC Column: permission_id, Type: CHAR(32)
DEBUG [conftest.py create_test_tables - SYNC]: Schema for table 'applications':
  SYNC Column: id, Type: CHAR(32)
  SYNC Column: name, Type: VARCHAR(255)
  SYNC Column: description, Type: TEXT
  SYNC Column: type, Type: VARCHAR(5)
    SYNC 'applications.type' column found. Type: VARCHAR(5)
  SYNC Column: hostedOn, Type: VARCHAR(255)
  SYNC Column: workarounds, Type: TEXT
  SYNC Column: derivedRTO, Type: VARCHAR(50)
  SYNC Column: status, Type: VARCHAR(8)
  SYNC Column: organizationId, Type: CHAR(32)
  SYNC Column: appOwnerId, Type: CHAR(32)
DEBUG [conftest.py create_test_tables_async]: Creating async tables...
DEBUG [conftest.py create_test_tables_async]: Async tables created.
DEBUG [conftest.py async_db_session]: Added default async organization: Default Test Organization Async
DEBUG [conftest.py async_db_session]: Added default async user: default.async.user@example.com
DEBUG [conftest.py async_db_session]: Committed default async org/user for session 4400623568.
Unexpected error in create_application: (pymysql.err.OperationalError) (1054, "Unknown column 'applications.type' in 'field list'")
[SQL: SELECT applications.id, applications.name, applications.description, applications.type, applications.`hostedOn`, applications.workarounds, applications.`derivedRTO`, applications.status, applications.`organizationId`, applications.`appOwnerId` 
FROM applications 
WHERE applications.name = %s AND applications.`organizationId` = %s AND applications.status = %s]
[parameters: ('My New Critical App', '00000000-0000-0000-0000-000000000001', 'ACTIVE')]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
FDEBUG [conftest.py async_db_session]: Committed default async org/user for session 4402273632.
Unexpected error in create_application: Task <Task pending name='Task-19' coro=<test_create_application_minimal_data() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:128> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop
FDEBUG [conftest.py async_db_session]: Committed default async org/user for session 4432801600.
Unexpected error in create_application: (pymysql.err.OperationalError) (1054, "Unknown column 'applications.type' in 'field list'")
[SQL: SELECT applications.id, applications.name, applications.description, applications.type, applications.`hostedOn`, applications.workarounds, applications.`derivedRTO`, applications.status, applications.`organizationId`, applications.`appOwnerId` 
FROM applications 
WHERE applications.name = %s AND applications.`organizationId` = %s AND applications.status = %s]
[parameters: ('App With Cross-Org Owner', '00000000-0000-0000-0000-000000000001', 'ACTIVE')]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
FDEBUG [conftest.py async_db_session]: Committed default async org/user for session 4436764224.
Unexpected error in create_application: Task <Task pending name='Task-44' coro=<test_create_application_duplicate_name() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:175> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop
FDEBUG [conftest.py async_db_session]: Committed default async org/user for session 4427406304.
Unexpected error in create_application: (pymysql.err.OperationalError) (1054, "Unknown column 'applications.type' in 'field list'")
[SQL: SELECT applications.id, applications.name, applications.description, applications.type, applications.`hostedOn`, applications.workarounds, applications.`derivedRTO`, applications.status, applications.`organizationId`, applications.`appOwnerId` 
FROM applications 
WHERE applications.name = %s AND applications.`organizationId` = %s AND applications.status = %s]
[parameters: ('My Readable App', '00000000-0000-0000-0000-000000000001', 'ACTIVE')]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
FDEBUG [conftest.py async_db_session]: Committed default async org/user for session 4428765984.
FDEBUG [conftest.py async_db_session]: Committed default async org/user for session 4404313344.
FDEBUG [conftest.py async_db_session]: Committed default async org/user for session 4430736640.
Unexpected error in create_application: Task <Task pending name='Task-94' coro=<test_read_applications_list() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:295> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop
FDEBUG [conftest.py async_db_session]: Committed default async org/user for session 4427231920.
Unexpected error in create_application: (pymysql.err.OperationalError) (1054, "Unknown column 'applications.type' in 'field list'")
[SQL: SELECT applications.id, applications.name, applications.description, applications.type, applications.`hostedOn`, applications.workarounds, applications.`derivedRTO`, applications.status, applications.`organizationId`, applications.`appOwnerId` 
FROM applications 
WHERE applications.name = %s AND applications.`organizationId` = %s AND applications.status = %s]
[parameters: ('Alpha App', '00000000-0000-0000-0000-000000000001', 'ACTIVE')]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
FDEBUG [conftest.py async_db_session]: Committed default async org/user for session 4429690720.
Unexpected error in create_application: Task <Task pending name='Task-119' coro=<test_update_application() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:477> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop
FDEBUG [conftest.py async_db_session]: Committed default async org/user for session 4440200336.
Unexpected error in update_application: (pymysql.err.OperationalError) (1054, "Unknown column 'applications.type' in 'field list'")
[SQL: SELECT applications.id, applications.name, applications.description, applications.type, applications.`hostedOn`, applications.workarounds, applications.`derivedRTO`, applications.status, applications.`organizationId`, applications.`appOwnerId`, organizations_1.id AS id_1, organizations_1.name AS name_1, organizations_1.description AS description_1, organizations_1.industry, organizations_1.`isActive`, organizations_1.`createdAt`, organizations_1.`updatedAt`, users_1.id AS id_2, users_1.`firstName`, users_1.`lastName`, users_1.email, users_1.`passwordHash`, users_1.`jobTitle`, users_1.`isActive` AS `isActive_1`, users_1.`createdAt` AS `createdAt_1`, users_1.`updatedAt` AS `updatedAt_1`, users_1.`organizationId` AS `organizationId_1`, users_1.`departmentId`, users_1.`locationId` 
FROM applications LEFT OUTER JOIN organizations AS organizations_1 ON organizations_1.id = applications.`organizationId` LEFT OUTER JOIN users AS users_1 ON users_1.id = applications.`appOwnerId` 
WHERE applications.id = %s AND applications.`organizationId` = %s AND applications.status = %s]
[parameters: ('96260909-6e4b-4393-b7ec-a3b66755b8c0', '00000000-0000-0000-0000-000000000001', 'ACTIVE')]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
FDEBUG [conftest.py async_db_session]: Committed default async org/user for session 4424480224.
Unexpected error in create_application: Task <Task pending name='Task-144' coro=<test_update_application_invalid_owner() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:525> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop
FDEBUG [conftest.py async_db_session]: Committed default async org/user for session 4430541584.
Unexpected error in create_application: (pymysql.err.OperationalError) (1054, "Unknown column 'applications.type' in 'field list'")
[SQL: SELECT applications.id, applications.name, applications.description, applications.type, applications.`hostedOn`, applications.workarounds, applications.`derivedRTO`, applications.status, applications.`organizationId`, applications.`appOwnerId` 
FROM applications 
WHERE applications.name = %s AND applications.`organizationId` = %s AND applications.status = %s]
[parameters: ('App To Be Soft Deleted', '00000000-0000-0000-0000-000000000001', 'ACTIVE')]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
FDEBUG [conftest.py async_db_session]: Committed default async org/user for session 4432623024.
Unexpected error in delete_application: Task <Task pending name='Task-169' coro=<test_delete_application_not_found() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:597> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop
FDEBUG [conftest.py async_db_session]: Committed default async org/user for session 4409185280.
EDEBUG [conftest.py async_db_session]: Committed default async org/user for session 4439197344.
EFDEBUG [conftest.py create_test_tables_async]: Dropping async tables...
DEBUG [conftest.py create_test_tables_async]: Async tables dropped.
DEBUG [conftest.py create_test_tables]: All tables dropped.


==================================== ERRORS ====================================
______ ERROR at setup of test_update_application_cross_organization_fail _______
file /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py, line 602
  @pytest.mark.asyncio
  async def test_update_application_cross_organization_fail(
      authenticated_test_client: AsyncClient,
      async_db_session: AsyncSession,
      async_current_test_user: UserModel
  ):
      # Create an organization different from the current_test_user's organization
      other_org = await create_test_organization_async(async_db_session, name="Other Org For Cross-Update Test")
      other_org_owner = await create_test_user_async(async_db_session, organization_id=other_org.id, first_name_prefix="OtherOrgOwnerUpdate")
      # No need to commit here as helper functions do it

      # Create an application in this 'other_org'
      cross_org_app_to_update = ApplicationModel(
          id=uuid.uuid4(),
          name="Cross-Org App For Update Test",
          organization_id=other_org.id,
          app_owner_id=other_org_owner.id,
          type=ApplicationType.OWNED.value,
          status="ACTIVE",
          created_by_id=async_current_test_user.id # Use current user for created_by_id
      )
      async_db_session.add(cross_org_app_to_update)
      await async_db_session.commit()
      await async_db_session.refresh(cross_org_app_to_update)

      update_payload = ApplicationUpdate(name="Attempted Cross-Org Update")

      # current_test_user (from a different org) attempts to update this app
      response = await authenticated_test_client.put(
          f"/api/v1/applications/{cross_org_app_to_update.id}",
          json=update_payload.model_dump(mode='json', exclude_unset=True)
      )

      assert response.status_code == 404, response.text
      assert response.json()["detail"] == "Application not found"
E       fixture 'async_current_test_user' not found
>       available fixtures: _class_event_loop, _function_event_loop, _module_event_loop, _package_event_loop, _session_event_loop, anyio_backend, anyio_backend_name, anyio_backend_options, async_db_session, async_engine_fixture, authenticated_test_client, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, create_test_tables, create_test_tables_async, current_test_user, db_session, doctest_namespace, event_loop, event_loop_policy, free_tcp_port, free_tcp_port_factory, free_udp_port, free_udp_port_factory, monkeypatch, override_get_async_db, override_get_db, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, test_client, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:602
______ ERROR at setup of test_delete_application_cross_organization_fail _______
file /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py, line 638
  @pytest.mark.asyncio
  async def test_delete_application_cross_organization_fail(
      authenticated_test_client: AsyncClient,
      async_db_session: AsyncSession,
      async_current_test_user: UserModel
  ):
      # Create an organization different from the current_test_user's organization
      other_org = await create_test_organization_async(async_db_session, name="Other Org For Cross-Delete Test")
      other_org_owner = await create_test_user_async(async_db_session, organization_id=other_org.id, first_name_prefix="OtherOrgOwnerDelete")

      # Create an application in this 'other_org'
      cross_org_app_to_delete = ApplicationModel(
          id=uuid.uuid4(),
          name="Cross-Org App To Delete Test",
          organization_id=other_org.id,
          app_owner_id=other_org_owner.id,
          type=ApplicationType.OWNED.value,
          status="ACTIVE",
          created_by_id=async_current_test_user.id # Use current user for created_by_id
      )
      async_db_session.add(cross_org_app_to_delete)
      await async_db_session.commit()
      await async_db_session.refresh(cross_org_app_to_delete)

      # current_test_user (from a different org) attempts to delete this app
      response = await authenticated_test_client.delete(f"/api/v1/applications/{cross_org_app_to_delete.id}")

      assert response.status_code == 404, response.text
      assert response.json()["detail"] == "Application not found"
E       fixture 'async_current_test_user' not found
>       available fixtures: _class_event_loop, _function_event_loop, _module_event_loop, _package_event_loop, _session_event_loop, anyio_backend, anyio_backend_name, anyio_backend_options, async_db_session, async_engine_fixture, authenticated_test_client, cache, capfd, capfdbinary, caplog, capsys, capsysbinary, create_test_tables, create_test_tables_async, current_test_user, db_session, doctest_namespace, event_loop, event_loop_policy, free_tcp_port, free_tcp_port_factory, free_udp_port, free_udp_port_factory, monkeypatch, override_get_async_db, override_get_db, pytestconfig, record_property, record_testsuite_property, record_xml_attribute, recwarn, test_client, tmp_path, tmp_path_factory, tmpdir, tmpdir_factory, unused_tcp_port, unused_tcp_port_factory, unused_udp_port, unused_udp_port_factory
>       use 'pytest --fixtures [testpath]' for help on them.

/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:638
=================================== FAILURES ===================================
___________________________ test_create_application ____________________________

authenticated_test_client = <httpx.AsyncClient object at 0x1064c2880>
async_db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x1064c2fd0>
current_test_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.async.user@example.com')>

    @pytest.mark.asyncio
    async def test_create_application(authenticated_test_client: AsyncClient, async_db_session: AsyncSession, current_test_user: UserModel):
        # current_test_user is assumed to be from the authenticated_test_client's token
        # The application's organization will be derived from this user.
        org_id_from_auth_user = current_test_user.organization_id
    
        # Create an app_owner in the same organization as the authenticated user
        app_owner = await create_test_user_async(async_db_session, organization_id=org_id_from_auth_user, first_name_prefix="AppOwnerFull")
    
        application_data = ApplicationCreate(
            name="My New Critical App",
            description="A very important application for testing purposes.",
            app_owner_id=app_owner.id, # Use the ID of the created user
            type=ApplicationType.OWNED.value,
            organization_id=str(org_id_from_auth_user),
            is_active=True,
            hosted_on="Cloud Provider X",
            workarounds="Use manual process as a workaround."
        )
    
        response = await authenticated_test_client.post("/api/v1/applications/", json=application_data.model_dump(mode='json'))
    
>       assert response.status_code == 201, response.text
E       AssertionError: {"detail":"An unexpected error occurred while creating the application."}
E       assert 500 == 201
E        +  where 500 = <Response [500 Internal Server Error]>.status_code

backend/app/tests/api/test_applications_api.py:100: AssertionError
_____________________ test_create_application_minimal_data _____________________

application_in = ApplicationCreate(name='Minimal App For Test', description=None, type=<ApplicationType.SAAS: 'SaaS'>, hosted_on=None, workarounds=None, is_active=True, organization_id=UUID('00000000-0000-0000-0000-000000000001'), app_owner_id=None)
db = <sqlalchemy.orm.session.AsyncSession object at 0x10650aa60>
current_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.user@example.com')>

    @router.post("/", response_model=ApplicationResponse, status_code=status.HTTP_201_CREATED)
    async def create_application(
        application_in: ApplicationCreate,
        db: Annotated[AsyncSession, Depends(get_async_db)],
        current_user: Annotated[User, Depends(get_current_active_user)]
        # current_user: Annotated[User, Depends(require_admin)] # For RBAC
    ):
        """
        Create a new application within the current user's organization.
        Requires admin privileges.
        """
        try:
            # The service layer will validate if app_owner_id (if provided) belongs to the same organization.
>           created_application = await application_service.create_application(
                db=db,
                application_in=application_in,
                current_user=current_user # Corrected: pass current_user object
            )

backend/app/apis/endpoints/applications.py:29: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
backend/app/services/application_service.py:62: in create_application
    organization = (await db.execute(org_stmt)).scalar_one_or_none()
venv/lib/python3.9/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
venv/lib/python3.9/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1415: in execute
    return meth(
venv/lib/python3.9/site-packages/sqlalchemy/sql/elements.py:523: in _execute_on_connection
    return connection._execute_clauseelement(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1637: in _execute_clauseelement
    ret = self._execute_context(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1842: in _execute_context
    return self._exec_single_context(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1982: in _exec_single_context
    self._handle_dbapi_exception(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2354: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1963: in _exec_single_context
    self.dialect.do_execute(
venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py:943: in do_execute
    cursor.execute(statement, parameters)
venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py:97: in execute
    return self.await_(self._execute_async(operation, parameters))
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py:106: in _execute_async
    result = await self._cursor.execute(operation, parameters)
venv/lib/python3.9/site-packages/aiomysql/cursors.py:239: in execute
    await self._query(query)
venv/lib/python3.9/site-packages/aiomysql/cursors.py:457: in _query
    await conn.query(q)
venv/lib/python3.9/site-packages/aiomysql/connection.py:469: in query
    await self._read_query_result(unbuffered=unbuffered)
venv/lib/python3.9/site-packages/aiomysql/connection.py:683: in _read_query_result
    await result.read()
venv/lib/python3.9/site-packages/aiomysql/connection.py:1164: in read
    first_packet = await self.connection._read_packet()
venv/lib/python3.9/site-packages/aiomysql/connection.py:609: in _read_packet
    packet_header = await self._read_bytes(4)
venv/lib/python3.9/site-packages/aiomysql/connection.py:657: in _read_bytes
    data = await self._reader.readexactly(num_bytes)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:723: in readexactly
    await self._wait_for_data('readexactly')
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <StreamReader transport=<_SelectorSocketTransport closing fd=17>>
func_name = 'readexactly'

    async def _wait_for_data(self, func_name):
        """Wait until feed_data() or feed_eof() is called.
    
        If stream was paused, automatically resume it.
        """
        # StreamReader uses a future to link the protocol feed_data() method
        # to a read coroutine. Running two read coroutines at the same time
        # would have an unexpected behaviour. It would not possible to know
        # which coroutine would get the next data.
        if self._waiter is not None:
            raise RuntimeError(
                f'{func_name}() called while another coroutine is '
                f'already waiting for incoming data')
    
        assert not self._eof, '_wait_for_data after EOF'
    
        # Waiting for data while paused will make deadlock, so prevent it.
        # This is essential for readexactly(n) for case when n > self._limit.
        if self._paused:
            self._paused = False
            self._transport.resume_reading()
    
        self._waiter = self._loop.create_future()
        try:
>           await self._waiter
E           RuntimeError: Task <Task pending name='Task-19' coro=<test_create_application_minimal_data() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:128> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop

/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:517: RuntimeError

During handling of the above exception, another exception occurred:

    async def get_async_db() -> Generator[AsyncSession, None, None]:
        async with AsyncSessionLocal() as session:
            try:
>               yield session

backend/app/apis/deps.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.9/site-packages/fastapi/routing.py:301: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.9/site-packages/fastapi/routing.py:212: in run_endpoint_function
    return await dependant.call(**values)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

application_in = ApplicationCreate(name='Minimal App For Test', description=None, type=<ApplicationType.SAAS: 'SaaS'>, hosted_on=None, workarounds=None, is_active=True, organization_id=UUID('00000000-0000-0000-0000-000000000001'), app_owner_id=None)
db = <sqlalchemy.orm.session.AsyncSession object at 0x10650aa60>
current_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.user@example.com')>

    @router.post("/", response_model=ApplicationResponse, status_code=status.HTTP_201_CREATED)
    async def create_application(
        application_in: ApplicationCreate,
        db: Annotated[AsyncSession, Depends(get_async_db)],
        current_user: Annotated[User, Depends(get_current_active_user)]
        # current_user: Annotated[User, Depends(require_admin)] # For RBAC
    ):
        """
        Create a new application within the current user's organization.
        Requires admin privileges.
        """
        try:
            # The service layer will validate if app_owner_id (if provided) belongs to the same organization.
            created_application = await application_service.create_application(
                db=db,
                application_in=application_in,
                current_user=current_user # Corrected: pass current_user object
            )
            return created_application
        except HTTPException as http_exc:
            raise http_exc # Re-raise HTTPException from service layer
        except ValueError as ve: # Catch specific validation errors if service raises them
            raise HTTPException(status_code=status.HTTP_422_UNPROCESSABLE_ENTITY, detail=str(ve))
        except Exception as e:
            # TODO: Log the exception e
            print(f"Unexpected error in create_application: {e}") # Temporary print
>           raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="An unexpected error occurred while creating the application.")
E           fastapi.exceptions.HTTPException: 500: An unexpected error occurred while creating the application.

backend/app/apis/endpoints/applications.py:42: HTTPException

During handling of the above exception, another exception occurred:

authenticated_test_client = <httpx.AsyncClient object at 0x106656eb0>
current_test_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.async.user@example.com')>

    @pytest.mark.asyncio
    async def test_create_application_minimal_data(authenticated_test_client: AsyncClient, current_test_user: UserModel):
        # The application's organization will be derived from current_test_user.
        org_id_from_auth_user = current_test_user.organization_id
    
        application_data = ApplicationCreate(
            name="Minimal App For Test",
            type=ApplicationType.SAAS.value, # Software as a Service
            organization_id=str(org_id_from_auth_user),
            is_active=True
            # No app_owner_id, description, hosted_on, workarounds
        )
>       response = await authenticated_test_client.post("/api/v1/applications/", json=application_data.model_dump(mode='json'))

backend/app/tests/api/test_applications_api.py:128: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.9/site-packages/httpx/_client.py:1859: in post
    return await self.request(
venv/lib/python3.9/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
venv/lib/python3.9/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
venv/lib/python3.9/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
venv/lib/python3.9/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
venv/lib/python3.9/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
venv/lib/python3.9/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
venv/lib/python3.9/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
venv/lib/python3.9/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.9/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.9/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.9/site-packages/starlette/routing.py:73: in app
    response = await f(request)
venv/lib/python3.9/site-packages/fastapi/routing.py:341: in app
    response.headers.raw.extend(solved_result.response.headers.raw)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py:651: in __aexit__
    raise exc_details[1]
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py:634: in __aexit__
    cb_suppress = await cb(*exc_details)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py:193: in __aexit__
    await self.gen.athrow(typ, value, traceback)
backend/app/apis/deps.py:77: in get_async_db
    await session.rollback()
venv/lib/python3.9/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:1395: in rollback
    raise rollback_err[1].with_traceback(rollback_err[2])
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:1360: in rollback
    t[1].rollback()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2607: in rollback
    self._do_rollback()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2726: in _do_rollback
    self._close_impl(try_deactivate=True)
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2709: in _close_impl
    self._connection_rollback_impl()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2701: in _connection_rollback_impl
    self.connection._rollback_impl()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1126: in _rollback_impl
    self._handle_dbapi_exception(e, None, None, None, None)
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2354: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1124: in _rollback_impl
    self.engine.dialect.do_rollback(self.connection)
venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py:703: in do_rollback
    dbapi_connection.rollback()
venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py:203: in rollback
    self.await_(self._connection.rollback())
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.9/site-packages/aiomysql/connection.py:399: in rollback
    await self._read_ok_packet()
venv/lib/python3.9/site-packages/aiomysql/connection.py:372: in _read_ok_packet
    pkt = await self._read_packet()
venv/lib/python3.9/site-packages/aiomysql/connection.py:609: in _read_packet
    packet_header = await self._read_bytes(4)
venv/lib/python3.9/site-packages/aiomysql/connection.py:657: in _read_bytes
    data = await self._reader.readexactly(num_bytes)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:723: in readexactly
    await self._wait_for_data('readexactly')
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <StreamReader transport=<_SelectorSocketTransport closing fd=17>>
func_name = 'readexactly'

    async def _wait_for_data(self, func_name):
        """Wait until feed_data() or feed_eof() is called.
    
        If stream was paused, automatically resume it.
        """
        # StreamReader uses a future to link the protocol feed_data() method
        # to a read coroutine. Running two read coroutines at the same time
        # would have an unexpected behaviour. It would not possible to know
        # which coroutine would get the next data.
        if self._waiter is not None:
            raise RuntimeError(
                f'{func_name}() called while another coroutine is '
                f'already waiting for incoming data')
    
        assert not self._eof, '_wait_for_data after EOF'
    
        # Waiting for data while paused will make deadlock, so prevent it.
        # This is essential for readexactly(n) for case when n > self._limit.
        if self._paused:
            self._paused = False
            self._transport.resume_reading()
    
        self._waiter = self._loop.create_future()
        try:
>           await self._waiter
E           RuntimeError: Task <Task pending name='Task-19' coro=<test_create_application_minimal_data() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:128> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop

/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:517: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:1009 Exception during reset or similar
Traceback (most recent call last):
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 987, in _finalize_fairy
    fairy._reset(
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 1433, in _reset
    pool._dialect.do_rollback(self)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py", line 703, in do_rollback
    dbapi_connection.rollback()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 203, in rollback
    self.await_(self._connection.rollback())
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 399, in rollback
    await self._read_ok_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 372, in _read_ok_packet
    pkt = await self._read_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 609, in _read_packet
    packet_header = await self._read_bytes(4)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 657, in _read_bytes
    data = await self._reader.readexactly(num_bytes)
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 723, in readexactly
    await self._wait_for_data('readexactly')
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 517, in _wait_for_data
    await self._waiter
RuntimeError: Task <Task pending name='Task-19' coro=<test_create_application_minimal_data() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:128> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:378 Exception terminating connection <AdaptedConnection <aiomysql.connection.Connection object at 0x1065a30a0>>
Traceback (most recent call last):
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 987, in _finalize_fairy
    fairy._reset(
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 1433, in _reset
    pool._dialect.do_rollback(self)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py", line 703, in do_rollback
    dbapi_connection.rollback()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 203, in rollback
    self.await_(self._connection.rollback())
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 399, in rollback
    await self._read_ok_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 372, in _read_ok_packet
    pkt = await self._read_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 609, in _read_packet
    packet_header = await self._read_bytes(4)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 657, in _read_bytes
    data = await self._reader.readexactly(num_bytes)
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 723, in readexactly
    await self._wait_for_data('readexactly')
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 517, in _wait_for_data
    await self._waiter
RuntimeError: Task <Task pending name='Task-19' coro=<test_create_application_minimal_data() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:128> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 374, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 312, in do_terminate
    dbapi_connection.terminate()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 210, in terminate
    self._connection.close()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 339, in close
    self._writer.transport.close()
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/selector_events.py", line 700, in close
    self._loop.call_soon(self._call_connection_lost, None)
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py", line 746, in call_soon
    self._check_closed()
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py", line 510, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_________________ test_create_application_invalid_app_owner_id _________________

authenticated_test_client = <httpx.AsyncClient object at 0x10843c190>
async_db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x108372f40>
current_test_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.async.user@example.com')>

    @pytest.mark.asyncio
    async def test_create_application_invalid_app_owner_id(authenticated_test_client: AsyncClient, async_db_session: AsyncSession, current_test_user: UserModel):
        # current_test_user.organization_id will be the app's organization
        # Create a different organization for the invalid app owner
        org_other = await create_test_organization_async(async_db_session, name="Other Org For Invalid Owner")
        app_owner_other_org = await create_test_user_async(async_db_session, organization_id=org_other.id, first_name_prefix="OtherOrgOwner")
    
        application_data = ApplicationCreate(
            name="App With Cross-Org Owner",
            type=ApplicationType.OWNED.value, # Commercial Off-The-Shelf
            organization_id=str(current_test_user.organization_id),
            is_active=True,
            app_owner_id=app_owner_other_org.id # Owner from a different org
        )
    
        response = await authenticated_test_client.post("/api/v1/applications/", json=application_data.model_dump(mode='json'))
    
>       assert response.status_code == 422, response.text
E       AssertionError: {"detail":"An unexpected error occurred while creating the application."}
E       assert 500 == 422
E        +  where 500 = <Response [500 Internal Server Error]>.status_code

backend/app/tests/api/test_applications_api.py:158: AssertionError
____________________ test_create_application_duplicate_name ____________________

application_in = ApplicationCreate(name='Unique App Name ddaa907c-2f31-41be-8be5-37a7035ae806', description=None, type=<ApplicationType...rganization_id=UUID('00000000-0000-0000-0000-000000000001'), app_owner_id=UUID('dcd7aad3-c688-4538-8216-4129846b7923'))
db = <sqlalchemy.orm.session.AsyncSession object at 0x1080777c0>
current_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.user@example.com')>

    @router.post("/", response_model=ApplicationResponse, status_code=status.HTTP_201_CREATED)
    async def create_application(
        application_in: ApplicationCreate,
        db: Annotated[AsyncSession, Depends(get_async_db)],
        current_user: Annotated[User, Depends(get_current_active_user)]
        # current_user: Annotated[User, Depends(require_admin)] # For RBAC
    ):
        """
        Create a new application within the current user's organization.
        Requires admin privileges.
        """
        try:
            # The service layer will validate if app_owner_id (if provided) belongs to the same organization.
>           created_application = await application_service.create_application(
                db=db,
                application_in=application_in,
                current_user=current_user # Corrected: pass current_user object
            )

backend/app/apis/endpoints/applications.py:29: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
backend/app/services/application_service.py:62: in create_application
    organization = (await db.execute(org_stmt)).scalar_one_or_none()
venv/lib/python3.9/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
venv/lib/python3.9/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1415: in execute
    return meth(
venv/lib/python3.9/site-packages/sqlalchemy/sql/elements.py:523: in _execute_on_connection
    return connection._execute_clauseelement(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1637: in _execute_clauseelement
    ret = self._execute_context(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1842: in _execute_context
    return self._exec_single_context(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1982: in _exec_single_context
    self._handle_dbapi_exception(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2354: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1963: in _exec_single_context
    self.dialect.do_execute(
venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py:943: in do_execute
    cursor.execute(statement, parameters)
venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py:97: in execute
    return self.await_(self._execute_async(operation, parameters))
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py:106: in _execute_async
    result = await self._cursor.execute(operation, parameters)
venv/lib/python3.9/site-packages/aiomysql/cursors.py:239: in execute
    await self._query(query)
venv/lib/python3.9/site-packages/aiomysql/cursors.py:457: in _query
    await conn.query(q)
venv/lib/python3.9/site-packages/aiomysql/connection.py:469: in query
    await self._read_query_result(unbuffered=unbuffered)
venv/lib/python3.9/site-packages/aiomysql/connection.py:683: in _read_query_result
    await result.read()
venv/lib/python3.9/site-packages/aiomysql/connection.py:1164: in read
    first_packet = await self.connection._read_packet()
venv/lib/python3.9/site-packages/aiomysql/connection.py:609: in _read_packet
    packet_header = await self._read_bytes(4)
venv/lib/python3.9/site-packages/aiomysql/connection.py:657: in _read_bytes
    data = await self._reader.readexactly(num_bytes)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:723: in readexactly
    await self._wait_for_data('readexactly')
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <StreamReader transport=<_SelectorSocketTransport closing fd=18>>
func_name = 'readexactly'

    async def _wait_for_data(self, func_name):
        """Wait until feed_data() or feed_eof() is called.
    
        If stream was paused, automatically resume it.
        """
        # StreamReader uses a future to link the protocol feed_data() method
        # to a read coroutine. Running two read coroutines at the same time
        # would have an unexpected behaviour. It would not possible to know
        # which coroutine would get the next data.
        if self._waiter is not None:
            raise RuntimeError(
                f'{func_name}() called while another coroutine is '
                f'already waiting for incoming data')
    
        assert not self._eof, '_wait_for_data after EOF'
    
        # Waiting for data while paused will make deadlock, so prevent it.
        # This is essential for readexactly(n) for case when n > self._limit.
        if self._paused:
            self._paused = False
            self._transport.resume_reading()
    
        self._waiter = self._loop.create_future()
        try:
>           await self._waiter
E           RuntimeError: Task <Task pending name='Task-44' coro=<test_create_application_duplicate_name() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:175> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop

/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:517: RuntimeError

During handling of the above exception, another exception occurred:

    async def get_async_db() -> Generator[AsyncSession, None, None]:
        async with AsyncSessionLocal() as session:
            try:
>               yield session

backend/app/apis/deps.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.9/site-packages/fastapi/routing.py:301: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.9/site-packages/fastapi/routing.py:212: in run_endpoint_function
    return await dependant.call(**values)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

application_in = ApplicationCreate(name='Unique App Name ddaa907c-2f31-41be-8be5-37a7035ae806', description=None, type=<ApplicationType...rganization_id=UUID('00000000-0000-0000-0000-000000000001'), app_owner_id=UUID('dcd7aad3-c688-4538-8216-4129846b7923'))
db = <sqlalchemy.orm.session.AsyncSession object at 0x1080777c0>
current_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.user@example.com')>

    @router.post("/", response_model=ApplicationResponse, status_code=status.HTTP_201_CREATED)
    async def create_application(
        application_in: ApplicationCreate,
        db: Annotated[AsyncSession, Depends(get_async_db)],
        current_user: Annotated[User, Depends(get_current_active_user)]
        # current_user: Annotated[User, Depends(require_admin)] # For RBAC
    ):
        """
        Create a new application within the current user's organization.
        Requires admin privileges.
        """
        try:
            # The service layer will validate if app_owner_id (if provided) belongs to the same organization.
            created_application = await application_service.create_application(
                db=db,
                application_in=application_in,
                current_user=current_user # Corrected: pass current_user object
            )
            return created_application
        except HTTPException as http_exc:
            raise http_exc # Re-raise HTTPException from service layer
        except ValueError as ve: # Catch specific validation errors if service raises them
            raise HTTPException(status_code=status.HTTP_422_UNPROCESSABLE_ENTITY, detail=str(ve))
        except Exception as e:
            # TODO: Log the exception e
            print(f"Unexpected error in create_application: {e}") # Temporary print
>           raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="An unexpected error occurred while creating the application.")
E           fastapi.exceptions.HTTPException: 500: An unexpected error occurred while creating the application.

backend/app/apis/endpoints/applications.py:42: HTTPException

During handling of the above exception, another exception occurred:

authenticated_test_client = <httpx.AsyncClient object at 0x10843ceb0>
async_db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x10873a640>
current_test_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.async.user@example.com')>

    @pytest.mark.asyncio
    async def test_create_application_duplicate_name(authenticated_test_client: AsyncClient, async_db_session: AsyncSession, current_test_user: UserModel):
        # The application's organization will be derived from current_test_user.
        app_owner_same_org = await create_test_user_async(async_db_session, organization_id=current_test_user.organization_id, first_name_prefix="DuplicateNameOwner")
    
        app_name = f"Unique App Name {uuid.uuid4()}"
    
        application_data_1 = ApplicationCreate(
            name=app_name,
            type=ApplicationType.OWNED.value,
            organization_id=str(current_test_user.organization_id),
            is_active=True,
            app_owner_id=app_owner_same_org.id
        )
>       response1 = await authenticated_test_client.post("/api/v1/applications/", json=application_data_1.model_dump(mode='json'))

backend/app/tests/api/test_applications_api.py:175: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.9/site-packages/httpx/_client.py:1859: in post
    return await self.request(
venv/lib/python3.9/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
venv/lib/python3.9/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
venv/lib/python3.9/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
venv/lib/python3.9/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
venv/lib/python3.9/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
venv/lib/python3.9/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
venv/lib/python3.9/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
venv/lib/python3.9/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.9/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.9/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.9/site-packages/starlette/routing.py:73: in app
    response = await f(request)
venv/lib/python3.9/site-packages/fastapi/routing.py:341: in app
    response.headers.raw.extend(solved_result.response.headers.raw)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py:651: in __aexit__
    raise exc_details[1]
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py:634: in __aexit__
    cb_suppress = await cb(*exc_details)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py:193: in __aexit__
    await self.gen.athrow(typ, value, traceback)
backend/app/apis/deps.py:77: in get_async_db
    await session.rollback()
venv/lib/python3.9/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:1395: in rollback
    raise rollback_err[1].with_traceback(rollback_err[2])
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:1360: in rollback
    t[1].rollback()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2607: in rollback
    self._do_rollback()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2726: in _do_rollback
    self._close_impl(try_deactivate=True)
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2709: in _close_impl
    self._connection_rollback_impl()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2701: in _connection_rollback_impl
    self.connection._rollback_impl()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1126: in _rollback_impl
    self._handle_dbapi_exception(e, None, None, None, None)
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2354: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1124: in _rollback_impl
    self.engine.dialect.do_rollback(self.connection)
venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py:703: in do_rollback
    dbapi_connection.rollback()
venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py:203: in rollback
    self.await_(self._connection.rollback())
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.9/site-packages/aiomysql/connection.py:399: in rollback
    await self._read_ok_packet()
venv/lib/python3.9/site-packages/aiomysql/connection.py:372: in _read_ok_packet
    pkt = await self._read_packet()
venv/lib/python3.9/site-packages/aiomysql/connection.py:609: in _read_packet
    packet_header = await self._read_bytes(4)
venv/lib/python3.9/site-packages/aiomysql/connection.py:657: in _read_bytes
    data = await self._reader.readexactly(num_bytes)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:723: in readexactly
    await self._wait_for_data('readexactly')
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <StreamReader transport=<_SelectorSocketTransport closing fd=18>>
func_name = 'readexactly'

    async def _wait_for_data(self, func_name):
        """Wait until feed_data() or feed_eof() is called.
    
        If stream was paused, automatically resume it.
        """
        # StreamReader uses a future to link the protocol feed_data() method
        # to a read coroutine. Running two read coroutines at the same time
        # would have an unexpected behaviour. It would not possible to know
        # which coroutine would get the next data.
        if self._waiter is not None:
            raise RuntimeError(
                f'{func_name}() called while another coroutine is '
                f'already waiting for incoming data')
    
        assert not self._eof, '_wait_for_data after EOF'
    
        # Waiting for data while paused will make deadlock, so prevent it.
        # This is essential for readexactly(n) for case when n > self._limit.
        if self._paused:
            self._paused = False
            self._transport.resume_reading()
    
        self._waiter = self._loop.create_future()
        try:
>           await self._waiter
E           RuntimeError: Task <Task pending name='Task-44' coro=<test_create_application_duplicate_name() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:175> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop

/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:517: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:1009 Exception during reset or similar
Traceback (most recent call last):
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 987, in _finalize_fairy
    fairy._reset(
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 1433, in _reset
    pool._dialect.do_rollback(self)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py", line 703, in do_rollback
    dbapi_connection.rollback()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 203, in rollback
    self.await_(self._connection.rollback())
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 399, in rollback
    await self._read_ok_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 372, in _read_ok_packet
    pkt = await self._read_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 609, in _read_packet
    packet_header = await self._read_bytes(4)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 657, in _read_bytes
    data = await self._reader.readexactly(num_bytes)
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 723, in readexactly
    await self._wait_for_data('readexactly')
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 517, in _wait_for_data
    await self._waiter
RuntimeError: Task <Task pending name='Task-44' coro=<test_create_application_duplicate_name() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:175> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:378 Exception terminating connection <AdaptedConnection <aiomysql.connection.Connection object at 0x108323d00>>
Traceback (most recent call last):
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 987, in _finalize_fairy
    fairy._reset(
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 1433, in _reset
    pool._dialect.do_rollback(self)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py", line 703, in do_rollback
    dbapi_connection.rollback()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 203, in rollback
    self.await_(self._connection.rollback())
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 399, in rollback
    await self._read_ok_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 372, in _read_ok_packet
    pkt = await self._read_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 609, in _read_packet
    packet_header = await self._read_bytes(4)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 657, in _read_bytes
    data = await self._reader.readexactly(num_bytes)
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 723, in readexactly
    await self._wait_for_data('readexactly')
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 517, in _wait_for_data
    await self._waiter
RuntimeError: Task <Task pending name='Task-44' coro=<test_create_application_duplicate_name() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:175> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 374, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 312, in do_terminate
    dbapi_connection.terminate()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 210, in terminate
    self._connection.close()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 339, in close
    self._writer.transport.close()
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/selector_events.py", line 700, in close
    self._loop.call_soon(self._call_connection_lost, None)
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py", line 746, in call_soon
    self._check_closed()
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py", line 510, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
____________________________ test_read_application _____________________________

authenticated_test_client = <httpx.AsyncClient object at 0x108489520>
db_session = <sqlalchemy.orm.session.Session object at 0x107fc2b50>
current_test_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.async.user@example.com')>

    @pytest.mark.asyncio
    async def test_read_application(authenticated_test_client: AsyncClient, db_session: Session, current_test_user: UserModel):
        org_id_current_user = current_test_user.organization_id
        app_owner = create_test_user(db_session, organization_id=org_id_current_user, first_name_prefix="ReadableAppOwner")
    
        application_create_data = ApplicationCreate(
            name="My Readable App",
            description="Description for readable app.",
            app_owner_id=app_owner.id,
            type=ApplicationType.OWNED.value,
            organization_id=str(org_id_current_user),
            is_active=True,
            hosted_on="On-Premise"
        )
    
        create_response = await authenticated_test_client.post("/api/v1/applications/", json=application_create_data.model_dump(mode='json'))
>       assert create_response.status_code == 201, create_response.text
E       AssertionError: {"detail":"An unexpected error occurred while creating the application."}
E       assert 500 == 201
E        +  where 500 = <Response [500 Internal Server Error]>.status_code

backend/app/tests/api/test_applications_api.py:207: AssertionError
_______________________ test_read_application_not_found ________________________

    async def get_async_db() -> Generator[AsyncSession, None, None]:
        async with AsyncSessionLocal() as session:
            try:
>               yield session

backend/app/apis/deps.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.9/site-packages/fastapi/routing.py:301: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.9/site-packages/fastapi/routing.py:212: in run_endpoint_function
    return await dependant.call(**values)
backend/app/apis/endpoints/applications.py:53: in read_application
    db_application = await application_service.get_application_by_id(
backend/app/services/application_service.py:34: in get_application_by_id
    result = await db.execute(stmt)
venv/lib/python3.9/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
venv/lib/python3.9/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1415: in execute
    return meth(
venv/lib/python3.9/site-packages/sqlalchemy/sql/elements.py:523: in _execute_on_connection
    return connection._execute_clauseelement(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1637: in _execute_clauseelement
    ret = self._execute_context(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1842: in _execute_context
    return self._exec_single_context(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1982: in _exec_single_context
    self._handle_dbapi_exception(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2354: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1963: in _exec_single_context
    self.dialect.do_execute(
venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py:943: in do_execute
    cursor.execute(statement, parameters)
venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py:97: in execute
    return self.await_(self._execute_async(operation, parameters))
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py:106: in _execute_async
    result = await self._cursor.execute(operation, parameters)
venv/lib/python3.9/site-packages/aiomysql/cursors.py:239: in execute
    await self._query(query)
venv/lib/python3.9/site-packages/aiomysql/cursors.py:457: in _query
    await conn.query(q)
venv/lib/python3.9/site-packages/aiomysql/connection.py:469: in query
    await self._read_query_result(unbuffered=unbuffered)
venv/lib/python3.9/site-packages/aiomysql/connection.py:683: in _read_query_result
    await result.read()
venv/lib/python3.9/site-packages/aiomysql/connection.py:1164: in read
    first_packet = await self.connection._read_packet()
venv/lib/python3.9/site-packages/aiomysql/connection.py:609: in _read_packet
    packet_header = await self._read_bytes(4)
venv/lib/python3.9/site-packages/aiomysql/connection.py:657: in _read_bytes
    data = await self._reader.readexactly(num_bytes)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:723: in readexactly
    await self._wait_for_data('readexactly')
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <StreamReader transport=<_SelectorSocketTransport closing fd=19>>
func_name = 'readexactly'

    async def _wait_for_data(self, func_name):
        """Wait until feed_data() or feed_eof() is called.
    
        If stream was paused, automatically resume it.
        """
        # StreamReader uses a future to link the protocol feed_data() method
        # to a read coroutine. Running two read coroutines at the same time
        # would have an unexpected behaviour. It would not possible to know
        # which coroutine would get the next data.
        if self._waiter is not None:
            raise RuntimeError(
                f'{func_name}() called while another coroutine is '
                f'already waiting for incoming data')
    
        assert not self._eof, '_wait_for_data after EOF'
    
        # Waiting for data while paused will make deadlock, so prevent it.
        # This is essential for readexactly(n) for case when n > self._limit.
        if self._paused:
            self._paused = False
            self._transport.resume_reading()
    
        self._waiter = self._loop.create_future()
        try:
>           await self._waiter
E           RuntimeError: Task <Task pending name='Task-69' coro=<test_read_application_not_found() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:255> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop

/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:517: RuntimeError

During handling of the above exception, another exception occurred:

authenticated_test_client = <httpx.AsyncClient object at 0x108713a60>
db_session = <sqlalchemy.orm.session.Session object at 0x107fc2910>
current_test_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.async.user@example.com')>

    @pytest.mark.asyncio
    async def test_read_application_not_found(authenticated_test_client: AsyncClient, db_session: Session, current_test_user: UserModel): # Added current_test_user for consistency
        non_existent_app_id = uuid.uuid4()
>       response = await authenticated_test_client.get(f"/api/v1/applications/{non_existent_app_id}")

backend/app/tests/api/test_applications_api.py:255: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.9/site-packages/httpx/_client.py:1768: in get
    return await self.request(
venv/lib/python3.9/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
venv/lib/python3.9/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
venv/lib/python3.9/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
venv/lib/python3.9/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
venv/lib/python3.9/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
venv/lib/python3.9/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
venv/lib/python3.9/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
venv/lib/python3.9/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.9/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.9/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.9/site-packages/starlette/routing.py:73: in app
    response = await f(request)
venv/lib/python3.9/site-packages/fastapi/routing.py:341: in app
    response.headers.raw.extend(solved_result.response.headers.raw)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py:651: in __aexit__
    raise exc_details[1]
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py:634: in __aexit__
    cb_suppress = await cb(*exc_details)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py:193: in __aexit__
    await self.gen.athrow(typ, value, traceback)
backend/app/apis/deps.py:77: in get_async_db
    await session.rollback()
venv/lib/python3.9/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:1395: in rollback
    raise rollback_err[1].with_traceback(rollback_err[2])
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:1360: in rollback
    t[1].rollback()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2607: in rollback
    self._do_rollback()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2726: in _do_rollback
    self._close_impl(try_deactivate=True)
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2709: in _close_impl
    self._connection_rollback_impl()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2701: in _connection_rollback_impl
    self.connection._rollback_impl()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1126: in _rollback_impl
    self._handle_dbapi_exception(e, None, None, None, None)
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2354: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1124: in _rollback_impl
    self.engine.dialect.do_rollback(self.connection)
venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py:703: in do_rollback
    dbapi_connection.rollback()
venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py:203: in rollback
    self.await_(self._connection.rollback())
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.9/site-packages/aiomysql/connection.py:399: in rollback
    await self._read_ok_packet()
venv/lib/python3.9/site-packages/aiomysql/connection.py:372: in _read_ok_packet
    pkt = await self._read_packet()
venv/lib/python3.9/site-packages/aiomysql/connection.py:609: in _read_packet
    packet_header = await self._read_bytes(4)
venv/lib/python3.9/site-packages/aiomysql/connection.py:657: in _read_bytes
    data = await self._reader.readexactly(num_bytes)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:723: in readexactly
    await self._wait_for_data('readexactly')
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <StreamReader transport=<_SelectorSocketTransport closing fd=19>>
func_name = 'readexactly'

    async def _wait_for_data(self, func_name):
        """Wait until feed_data() or feed_eof() is called.
    
        If stream was paused, automatically resume it.
        """
        # StreamReader uses a future to link the protocol feed_data() method
        # to a read coroutine. Running two read coroutines at the same time
        # would have an unexpected behaviour. It would not possible to know
        # which coroutine would get the next data.
        if self._waiter is not None:
            raise RuntimeError(
                f'{func_name}() called while another coroutine is '
                f'already waiting for incoming data')
    
        assert not self._eof, '_wait_for_data after EOF'
    
        # Waiting for data while paused will make deadlock, so prevent it.
        # This is essential for readexactly(n) for case when n > self._limit.
        if self._paused:
            self._paused = False
            self._transport.resume_reading()
    
        self._waiter = self._loop.create_future()
        try:
>           await self._waiter
E           RuntimeError: Task <Task pending name='Task-69' coro=<test_read_application_not_found() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:255> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop

/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:517: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:1009 Exception during reset or similar
Traceback (most recent call last):
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 987, in _finalize_fairy
    fairy._reset(
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 1433, in _reset
    pool._dialect.do_rollback(self)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py", line 703, in do_rollback
    dbapi_connection.rollback()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 203, in rollback
    self.await_(self._connection.rollback())
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 399, in rollback
    await self._read_ok_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 372, in _read_ok_packet
    pkt = await self._read_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 609, in _read_packet
    packet_header = await self._read_bytes(4)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 657, in _read_bytes
    data = await self._reader.readexactly(num_bytes)
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 723, in readexactly
    await self._wait_for_data('readexactly')
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 517, in _wait_for_data
    await self._waiter
RuntimeError: Task <Task pending name='Task-69' coro=<test_read_application_not_found() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:255> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:378 Exception terminating connection <AdaptedConnection <aiomysql.connection.Connection object at 0x107e34790>>
Traceback (most recent call last):
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 987, in _finalize_fairy
    fairy._reset(
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 1433, in _reset
    pool._dialect.do_rollback(self)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py", line 703, in do_rollback
    dbapi_connection.rollback()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 203, in rollback
    self.await_(self._connection.rollback())
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 399, in rollback
    await self._read_ok_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 372, in _read_ok_packet
    pkt = await self._read_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 609, in _read_packet
    packet_header = await self._read_bytes(4)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 657, in _read_bytes
    data = await self._reader.readexactly(num_bytes)
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 723, in readexactly
    await self._wait_for_data('readexactly')
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 517, in _wait_for_data
    await self._waiter
RuntimeError: Task <Task pending name='Task-69' coro=<test_read_application_not_found() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:255> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 374, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 312, in do_terminate
    dbapi_connection.terminate()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 210, in terminate
    self._connection.close()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 339, in close
    self._writer.transport.close()
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/selector_events.py", line 700, in close
    self._loop.call_soon(self._call_connection_lost, None)
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py", line 746, in call_soon
    self._check_closed()
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py", line 510, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_________________________ test_read_applications_empty _________________________

self = <sqlalchemy.engine.base.Connection object at 0x106b59f40>
dialect = <sqlalchemy.dialects.mysql.aiomysql.MySQLDialect_aiomysql object at 0x105bafeb0>
context = <sqlalchemy.dialects.mysql.mysqldb.MySQLExecutionContext_mysqldb object at 0x1069ad910>
statement = <sqlalchemy.dialects.mysql.mysqldb.MySQLCompiler_mysqldb object at 0x1069adf10>
parameters = [('00000000-0000-0000-0000-000000000001', 'ACTIVE', 0, 100)]

    def _exec_single_context(
        self,
        dialect: Dialect,
        context: ExecutionContext,
        statement: Union[str, Compiled],
        parameters: Optional[_AnyMultiExecuteParams],
    ) -> CursorResult[Any]:
        """continue the _execute_context() method for a single DBAPI
        cursor.execute() or cursor.executemany() call.
    
        """
        if dialect.bind_typing is BindTyping.SETINPUTSIZES:
            generic_setinputsizes = context._prepare_set_input_sizes()
    
            if generic_setinputsizes:
                try:
                    dialect.do_set_input_sizes(
                        context.cursor, generic_setinputsizes, context
                    )
                except BaseException as e:
                    self._handle_dbapi_exception(
                        e, str(statement), parameters, None, context
                    )
    
        cursor, str_statement, parameters = (
            context.cursor,
            context.statement,
            context.parameters,
        )
    
        effective_parameters: Optional[_AnyExecuteParams]
    
        if not context.executemany:
            effective_parameters = parameters[0]
        else:
            effective_parameters = parameters
    
        if self._has_events or self.engine._has_events:
            for fn in self.dispatch.before_cursor_execute:
                str_statement, effective_parameters = fn(
                    self,
                    cursor,
                    str_statement,
                    effective_parameters,
                    context,
                    context.executemany,
                )
    
        if self._echo:
            self._log_info(str_statement)
    
            stats = context._get_cache_stats()
    
            if not self.engine.hide_parameters:
                self._log_info(
                    "[%s] %r",
                    stats,
                    sql_util._repr_params(
                        effective_parameters,
                        batches=10,
                        ismulti=context.executemany,
                    ),
                )
            else:
                self._log_info(
                    "[%s] [SQL parameters hidden due to hide_parameters=True]",
                    stats,
                )
    
        evt_handled: bool = False
        try:
            if context.execute_style is ExecuteStyle.EXECUTEMANY:
                effective_parameters = cast(
                    "_CoreMultiExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_executemany:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_executemany(
                        cursor,
                        str_statement,
                        effective_parameters,
                        context,
                    )
            elif not effective_parameters and context.no_parameters:
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute_no_params:
                        if fn(cursor, str_statement, context):
                            evt_handled = True
                            break
                if not evt_handled:
                    self.dialect.do_execute_no_params(
                        cursor, str_statement, context
                    )
            else:
                effective_parameters = cast(
                    "_CoreSingleExecuteParams", effective_parameters
                )
                if self.dialect._has_events:
                    for fn in self.dialect.dispatch.do_execute:
                        if fn(
                            cursor,
                            str_statement,
                            effective_parameters,
                            context,
                        ):
                            evt_handled = True
                            break
                if not evt_handled:
>                   self.dialect.do_execute(
                        cursor, str_statement, effective_parameters, context
                    )

venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1963: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py:943: in do_execute
    cursor.execute(statement, parameters)
venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py:97: in execute
    return self.await_(self._execute_async(operation, parameters))
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py:106: in _execute_async
    result = await self._cursor.execute(operation, parameters)
venv/lib/python3.9/site-packages/aiomysql/cursors.py:239: in execute
    await self._query(query)
venv/lib/python3.9/site-packages/aiomysql/cursors.py:457: in _query
    await conn.query(q)
venv/lib/python3.9/site-packages/aiomysql/connection.py:469: in query
    await self._read_query_result(unbuffered=unbuffered)
venv/lib/python3.9/site-packages/aiomysql/connection.py:683: in _read_query_result
    await result.read()
venv/lib/python3.9/site-packages/aiomysql/connection.py:1164: in read
    first_packet = await self.connection._read_packet()
venv/lib/python3.9/site-packages/aiomysql/connection.py:652: in _read_packet
    packet.raise_for_error()
venv/lib/python3.9/site-packages/pymysql/protocol.py:219: in raise_for_error
    err.raise_mysql_exception(self._data)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

data = b"\xff\x1e\x04#42S22Unknown column 'applications.type' in 'field list'"

    def raise_mysql_exception(data):
        errno = struct.unpack("<h", data[1:3])[0]
        # https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_basic_err_packet.html
        # Error packet has optional sqlstate that is 5 bytes and starts with '#'.
        if data[3] == 0x23:  # '#'
            # sqlstate = data[4:9].decode()
            # TODO: Append (sqlstate) in the error message. This will be come in next minor release.
            errval = data[9:].decode("utf-8", "replace")
        else:
            errval = data[3:].decode("utf-8", "replace")
        errorclass = error_map.get(errno)
        if errorclass is None:
            errorclass = InternalError if errno < 1000 else OperationalError
>       raise errorclass(errno, errval)
E       pymysql.err.OperationalError: (1054, "Unknown column 'applications.type' in 'field list'")

venv/lib/python3.9/site-packages/pymysql/err.py:150: OperationalError

The above exception was the direct cause of the following exception:

authenticated_test_client = <httpx.AsyncClient object at 0x106be0d60>
current_test_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.async.user@example.com')>

    @pytest.mark.asyncio
    async def test_read_applications_empty(authenticated_test_client: AsyncClient, current_test_user: UserModel): # Added current_test_user
        # This test assumes that for the current_test_user's organization, no applications exist yet.
        # If other tests create apps for this org without cleaning up, this test might be flaky.
        # Consider adding cleanup or ensuring a fresh org for this test if needed.
>       response = await authenticated_test_client.get("/api/v1/applications/")

backend/app/tests/api/test_applications_api.py:264: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.9/site-packages/httpx/_client.py:1768: in get
    return await self.request(
venv/lib/python3.9/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
venv/lib/python3.9/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
venv/lib/python3.9/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
venv/lib/python3.9/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
venv/lib/python3.9/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
venv/lib/python3.9/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
venv/lib/python3.9/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
venv/lib/python3.9/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.9/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.9/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.9/site-packages/starlette/routing.py:73: in app
    response = await f(request)
venv/lib/python3.9/site-packages/fastapi/routing.py:301: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.9/site-packages/fastapi/routing.py:212: in run_endpoint_function
    return await dependant.call(**values)
backend/app/apis/endpoints/applications.py:73: in read_applications
    applications = await application_service.get_applications(
backend/app/services/application_service.py:52: in get_applications
    result = await db.execute(stmt)
venv/lib/python3.9/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
venv/lib/python3.9/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1415: in execute
    return meth(
venv/lib/python3.9/site-packages/sqlalchemy/sql/elements.py:523: in _execute_on_connection
    return connection._execute_clauseelement(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1637: in _execute_clauseelement
    ret = self._execute_context(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1842: in _execute_context
    return self._exec_single_context(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1982: in _exec_single_context
    self._handle_dbapi_exception(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2351: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1963: in _exec_single_context
    self.dialect.do_execute(
venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py:943: in do_execute
    cursor.execute(statement, parameters)
venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py:97: in execute
    return self.await_(self._execute_async(operation, parameters))
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py:106: in _execute_async
    result = await self._cursor.execute(operation, parameters)
venv/lib/python3.9/site-packages/aiomysql/cursors.py:239: in execute
    await self._query(query)
venv/lib/python3.9/site-packages/aiomysql/cursors.py:457: in _query
    await conn.query(q)
venv/lib/python3.9/site-packages/aiomysql/connection.py:469: in query
    await self._read_query_result(unbuffered=unbuffered)
venv/lib/python3.9/site-packages/aiomysql/connection.py:683: in _read_query_result
    await result.read()
venv/lib/python3.9/site-packages/aiomysql/connection.py:1164: in read
    first_packet = await self.connection._read_packet()
venv/lib/python3.9/site-packages/aiomysql/connection.py:652: in _read_packet
    packet.raise_for_error()
venv/lib/python3.9/site-packages/pymysql/protocol.py:219: in raise_for_error
    err.raise_mysql_exception(self._data)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

data = b"\xff\x1e\x04#42S22Unknown column 'applications.type' in 'field list'"

    def raise_mysql_exception(data):
        errno = struct.unpack("<h", data[1:3])[0]
        # https://dev.mysql.com/doc/dev/mysql-server/latest/page_protocol_basic_err_packet.html
        # Error packet has optional sqlstate that is 5 bytes and starts with '#'.
        if data[3] == 0x23:  # '#'
            # sqlstate = data[4:9].decode()
            # TODO: Append (sqlstate) in the error message. This will be come in next minor release.
            errval = data[9:].decode("utf-8", "replace")
        else:
            errval = data[3:].decode("utf-8", "replace")
        errorclass = error_map.get(errno)
        if errorclass is None:
            errorclass = InternalError if errno < 1000 else OperationalError
>       raise errorclass(errno, errval)
E       sqlalchemy.exc.OperationalError: (pymysql.err.OperationalError) (1054, "Unknown column 'applications.type' in 'field list'")
E       [SQL: SELECT applications.id, applications.name, applications.description, applications.type, applications.`hostedOn`, applications.workarounds, applications.`derivedRTO`, applications.status, applications.`organizationId`, applications.`appOwnerId`, organizations_1.id AS id_1, organizations_1.name AS name_1, organizations_1.description AS description_1, organizations_1.industry, organizations_1.`isActive`, organizations_1.`createdAt`, organizations_1.`updatedAt`, users_1.id AS id_2, users_1.`firstName`, users_1.`lastName`, users_1.email, users_1.`passwordHash`, users_1.`jobTitle`, users_1.`isActive` AS `isActive_1`, users_1.`createdAt` AS `createdAt_1`, users_1.`updatedAt` AS `updatedAt_1`, users_1.`organizationId` AS `organizationId_1`, users_1.`departmentId`, users_1.`locationId` 
E       FROM applications LEFT OUTER JOIN organizations AS organizations_1 ON organizations_1.id = applications.`organizationId` LEFT OUTER JOIN users AS users_1 ON users_1.id = applications.`appOwnerId` 
E       WHERE applications.`organizationId` = %s AND applications.status = %s ORDER BY applications.name 
E        LIMIT %s, %s]
E       [parameters: ('00000000-0000-0000-0000-000000000001', 'ACTIVE', 0, 100)]
E       (Background on this error at: https://sqlalche.me/e/20/e3q8)

venv/lib/python3.9/site-packages/pymysql/err.py:150: OperationalError
_________________________ test_read_applications_list __________________________

application_in = ApplicationCreate(name='Listed App Alpha', description=None, type=<ApplicationType.OWNED: 'Owned'>, hosted_on=None, wo...rganization_id=UUID('00000000-0000-0000-0000-000000000001'), app_owner_id=UUID('ea1d9728-6e1c-4099-8c1c-5cd26400198c'))
db = <sqlalchemy.orm.session.AsyncSession object at 0x107942640>
current_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.user@example.com')>

    @router.post("/", response_model=ApplicationResponse, status_code=status.HTTP_201_CREATED)
    async def create_application(
        application_in: ApplicationCreate,
        db: Annotated[AsyncSession, Depends(get_async_db)],
        current_user: Annotated[User, Depends(get_current_active_user)]
        # current_user: Annotated[User, Depends(require_admin)] # For RBAC
    ):
        """
        Create a new application within the current user's organization.
        Requires admin privileges.
        """
        try:
            # The service layer will validate if app_owner_id (if provided) belongs to the same organization.
>           created_application = await application_service.create_application(
                db=db,
                application_in=application_in,
                current_user=current_user # Corrected: pass current_user object
            )

backend/app/apis/endpoints/applications.py:29: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
backend/app/services/application_service.py:62: in create_application
    organization = (await db.execute(org_stmt)).scalar_one_or_none()
venv/lib/python3.9/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
venv/lib/python3.9/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1415: in execute
    return meth(
venv/lib/python3.9/site-packages/sqlalchemy/sql/elements.py:523: in _execute_on_connection
    return connection._execute_clauseelement(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1637: in _execute_clauseelement
    ret = self._execute_context(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1842: in _execute_context
    return self._exec_single_context(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1982: in _exec_single_context
    self._handle_dbapi_exception(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2354: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1963: in _exec_single_context
    self.dialect.do_execute(
venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py:943: in do_execute
    cursor.execute(statement, parameters)
venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py:97: in execute
    return self.await_(self._execute_async(operation, parameters))
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py:106: in _execute_async
    result = await self._cursor.execute(operation, parameters)
venv/lib/python3.9/site-packages/aiomysql/cursors.py:239: in execute
    await self._query(query)
venv/lib/python3.9/site-packages/aiomysql/cursors.py:457: in _query
    await conn.query(q)
venv/lib/python3.9/site-packages/aiomysql/connection.py:469: in query
    await self._read_query_result(unbuffered=unbuffered)
venv/lib/python3.9/site-packages/aiomysql/connection.py:683: in _read_query_result
    await result.read()
venv/lib/python3.9/site-packages/aiomysql/connection.py:1164: in read
    first_packet = await self.connection._read_packet()
venv/lib/python3.9/site-packages/aiomysql/connection.py:609: in _read_packet
    packet_header = await self._read_bytes(4)
venv/lib/python3.9/site-packages/aiomysql/connection.py:657: in _read_bytes
    data = await self._reader.readexactly(num_bytes)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:723: in readexactly
    await self._wait_for_data('readexactly')
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <StreamReader transport=<_SelectorSocketTransport closing fd=20>>
func_name = 'readexactly'

    async def _wait_for_data(self, func_name):
        """Wait until feed_data() or feed_eof() is called.
    
        If stream was paused, automatically resume it.
        """
        # StreamReader uses a future to link the protocol feed_data() method
        # to a read coroutine. Running two read coroutines at the same time
        # would have an unexpected behaviour. It would not possible to know
        # which coroutine would get the next data.
        if self._waiter is not None:
            raise RuntimeError(
                f'{func_name}() called while another coroutine is '
                f'already waiting for incoming data')
    
        assert not self._eof, '_wait_for_data after EOF'
    
        # Waiting for data while paused will make deadlock, so prevent it.
        # This is essential for readexactly(n) for case when n > self._limit.
        if self._paused:
            self._paused = False
            self._transport.resume_reading()
    
        self._waiter = self._loop.create_future()
        try:
>           await self._waiter
E           RuntimeError: Task <Task pending name='Task-94' coro=<test_read_applications_list() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:295> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop

/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:517: RuntimeError

During handling of the above exception, another exception occurred:

    async def get_async_db() -> Generator[AsyncSession, None, None]:
        async with AsyncSessionLocal() as session:
            try:
>               yield session

backend/app/apis/deps.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.9/site-packages/fastapi/routing.py:301: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.9/site-packages/fastapi/routing.py:212: in run_endpoint_function
    return await dependant.call(**values)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

application_in = ApplicationCreate(name='Listed App Alpha', description=None, type=<ApplicationType.OWNED: 'Owned'>, hosted_on=None, wo...rganization_id=UUID('00000000-0000-0000-0000-000000000001'), app_owner_id=UUID('ea1d9728-6e1c-4099-8c1c-5cd26400198c'))
db = <sqlalchemy.orm.session.AsyncSession object at 0x107942640>
current_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.user@example.com')>

    @router.post("/", response_model=ApplicationResponse, status_code=status.HTTP_201_CREATED)
    async def create_application(
        application_in: ApplicationCreate,
        db: Annotated[AsyncSession, Depends(get_async_db)],
        current_user: Annotated[User, Depends(get_current_active_user)]
        # current_user: Annotated[User, Depends(require_admin)] # For RBAC
    ):
        """
        Create a new application within the current user's organization.
        Requires admin privileges.
        """
        try:
            # The service layer will validate if app_owner_id (if provided) belongs to the same organization.
            created_application = await application_service.create_application(
                db=db,
                application_in=application_in,
                current_user=current_user # Corrected: pass current_user object
            )
            return created_application
        except HTTPException as http_exc:
            raise http_exc # Re-raise HTTPException from service layer
        except ValueError as ve: # Catch specific validation errors if service raises them
            raise HTTPException(status_code=status.HTTP_422_UNPROCESSABLE_ENTITY, detail=str(ve))
        except Exception as e:
            # TODO: Log the exception e
            print(f"Unexpected error in create_application: {e}") # Temporary print
>           raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="An unexpected error occurred while creating the application.")
E           fastapi.exceptions.HTTPException: 500: An unexpected error occurred while creating the application.

backend/app/apis/endpoints/applications.py:42: HTTPException

During handling of the above exception, another exception occurred:

authenticated_test_client = <httpx.AsyncClient object at 0x108834760>
db_session = <sqlalchemy.orm.session.Session object at 0x1087d2880>
current_test_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.async.user@example.com')>

    @pytest.mark.asyncio
    async def test_read_applications_list(authenticated_test_client: AsyncClient, db_session: Session, current_test_user: UserModel):
        org_id_current_user = current_test_user.organization_id
        app_owner1 = create_test_user(db_session, organization_id=org_id_current_user, first_name_prefix="ListAppOwner1")
        app_owner2 = create_test_user(db_session, organization_id=org_id_current_user, first_name_prefix="ListAppOwner2")
    
        app1_create_data = ApplicationCreate(
            name="Listed App Alpha",
            type=ApplicationType.OWNED.value,
            organization_id=str(org_id_current_user),
            is_active=True,
            app_owner_id=app_owner1.id
        )
        app2_create_data = ApplicationCreate(
            name="Listed App Beta",
            type=ApplicationType.OWNED.value,
            organization_id=str(org_id_current_user),
            is_active=True,
            app_owner_id=app_owner2.id,
            description="Beta version"
        )
    
        # Create two applications in the current user's organization
>       response_create1 = await authenticated_test_client.post("/api/v1/applications/", json=app1_create_data.model_dump(mode='json'))

backend/app/tests/api/test_applications_api.py:295: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.9/site-packages/httpx/_client.py:1859: in post
    return await self.request(
venv/lib/python3.9/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
venv/lib/python3.9/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
venv/lib/python3.9/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
venv/lib/python3.9/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
venv/lib/python3.9/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
venv/lib/python3.9/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
venv/lib/python3.9/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
venv/lib/python3.9/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.9/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.9/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.9/site-packages/starlette/routing.py:73: in app
    response = await f(request)
venv/lib/python3.9/site-packages/fastapi/routing.py:341: in app
    response.headers.raw.extend(solved_result.response.headers.raw)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py:651: in __aexit__
    raise exc_details[1]
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py:634: in __aexit__
    cb_suppress = await cb(*exc_details)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py:193: in __aexit__
    await self.gen.athrow(typ, value, traceback)
backend/app/apis/deps.py:77: in get_async_db
    await session.rollback()
venv/lib/python3.9/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:1395: in rollback
    raise rollback_err[1].with_traceback(rollback_err[2])
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:1360: in rollback
    t[1].rollback()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2607: in rollback
    self._do_rollback()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2726: in _do_rollback
    self._close_impl(try_deactivate=True)
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2709: in _close_impl
    self._connection_rollback_impl()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2701: in _connection_rollback_impl
    self.connection._rollback_impl()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1126: in _rollback_impl
    self._handle_dbapi_exception(e, None, None, None, None)
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2354: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1124: in _rollback_impl
    self.engine.dialect.do_rollback(self.connection)
venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py:703: in do_rollback
    dbapi_connection.rollback()
venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py:203: in rollback
    self.await_(self._connection.rollback())
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.9/site-packages/aiomysql/connection.py:399: in rollback
    await self._read_ok_packet()
venv/lib/python3.9/site-packages/aiomysql/connection.py:372: in _read_ok_packet
    pkt = await self._read_packet()
venv/lib/python3.9/site-packages/aiomysql/connection.py:609: in _read_packet
    packet_header = await self._read_bytes(4)
venv/lib/python3.9/site-packages/aiomysql/connection.py:657: in _read_bytes
    data = await self._reader.readexactly(num_bytes)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:723: in readexactly
    await self._wait_for_data('readexactly')
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <StreamReader transport=<_SelectorSocketTransport closing fd=20>>
func_name = 'readexactly'

    async def _wait_for_data(self, func_name):
        """Wait until feed_data() or feed_eof() is called.
    
        If stream was paused, automatically resume it.
        """
        # StreamReader uses a future to link the protocol feed_data() method
        # to a read coroutine. Running two read coroutines at the same time
        # would have an unexpected behaviour. It would not possible to know
        # which coroutine would get the next data.
        if self._waiter is not None:
            raise RuntimeError(
                f'{func_name}() called while another coroutine is '
                f'already waiting for incoming data')
    
        assert not self._eof, '_wait_for_data after EOF'
    
        # Waiting for data while paused will make deadlock, so prevent it.
        # This is essential for readexactly(n) for case when n > self._limit.
        if self._paused:
            self._paused = False
            self._transport.resume_reading()
    
        self._waiter = self._loop.create_future()
        try:
>           await self._waiter
E           RuntimeError: Task <Task pending name='Task-94' coro=<test_read_applications_list() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:295> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop

/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:517: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:1009 Exception during reset or similar
Traceback (most recent call last):
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 987, in _finalize_fairy
    fairy._reset(
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 1433, in _reset
    pool._dialect.do_rollback(self)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py", line 703, in do_rollback
    dbapi_connection.rollback()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 203, in rollback
    self.await_(self._connection.rollback())
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 399, in rollback
    await self._read_ok_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 372, in _read_ok_packet
    pkt = await self._read_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 609, in _read_packet
    packet_header = await self._read_bytes(4)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 657, in _read_bytes
    data = await self._reader.readexactly(num_bytes)
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 723, in readexactly
    await self._wait_for_data('readexactly')
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 517, in _wait_for_data
    await self._waiter
RuntimeError: Task <Task pending name='Task-94' coro=<test_read_applications_list() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:295> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:378 Exception terminating connection <AdaptedConnection <aiomysql.connection.Connection object at 0x106b595b0>>
Traceback (most recent call last):
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 987, in _finalize_fairy
    fairy._reset(
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 1433, in _reset
    pool._dialect.do_rollback(self)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py", line 703, in do_rollback
    dbapi_connection.rollback()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 203, in rollback
    self.await_(self._connection.rollback())
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 399, in rollback
    await self._read_ok_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 372, in _read_ok_packet
    pkt = await self._read_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 609, in _read_packet
    packet_header = await self._read_bytes(4)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 657, in _read_bytes
    data = await self._reader.readexactly(num_bytes)
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 723, in readexactly
    await self._wait_for_data('readexactly')
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 517, in _wait_for_data
    await self._waiter
RuntimeError: Task <Task pending name='Task-94' coro=<test_read_applications_list() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:295> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 374, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 312, in do_terminate
    dbapi_connection.terminate()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 210, in terminate
    self._connection.close()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 339, in close
    self._writer.transport.close()
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/selector_events.py", line 700, in close
    self._loop.call_soon(self._call_connection_lost, None)
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py", line 746, in call_soon
    self._check_closed()
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py", line 510, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
_______________ test_read_applications_pagination_and_filtering ________________

authenticated_test_client = <httpx.AsyncClient object at 0x106acfa30>
db_session = <sqlalchemy.orm.session.Session object at 0x108844760>
current_test_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.async.user@example.com')>

    @pytest.mark.asyncio
    async def test_read_applications_pagination_and_filtering(authenticated_test_client: AsyncClient, db_session: Session, current_test_user: UserModel):
        org_id = current_test_user.organization_id
        # Helper to create apps for this test via API
        async def _create_app(name: str, app_type: ApplicationType, description: str = "Test app"):
            app_owner = create_test_user(db_session, organization_id=org_id, first_name_prefix=f"Owner{name.replace(' ', '')}")
            payload = ApplicationCreate(name=name, type=app_type, organization_id=str(org_id), app_owner_id=app_owner.id, description=description, is_active=True)
            response = await authenticated_test_client.post("/api/v1/applications/", json=payload.model_dump(mode='json'))
            assert response.status_code == 201, f"Failed to create {name}: {response.text}"
            return response.json()
    
        # Create a set of applications
        app_configs = [
            {"name": "Alpha App", "type": ApplicationType.OWNED.value, "desc": "Alpha custom app"},
            {"name": "Bravo App", "type": ApplicationType.SAAS.value, "desc": "Bravo SaaS solution"},
            {"name": "Charlie App", "type": ApplicationType.OWNED.value, "desc": "Charlie custom app"},
            {"name": "Delta App", "type": ApplicationType.OWNED.value, "desc": "Delta COTS package"},
            {"name": "Echo App", "type": ApplicationType.SAAS.value, "desc": "Echo SaaS platform"},
            {"name": "Foxtrot App Special", "type": ApplicationType.OWNED.value, "desc": "Foxtrot special project"}
        ]
        created_apps = []
        for config in app_configs:
>           app_data = await _create_app(config["name"], config["type"], config["desc"])

backend/app/tests/api/test_applications_api.py:365: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

name = 'Alpha App', app_type = 'Owned', description = 'Alpha custom app'

    async def _create_app(name: str, app_type: ApplicationType, description: str = "Test app"):
        app_owner = create_test_user(db_session, organization_id=org_id, first_name_prefix=f"Owner{name.replace(' ', '')}")
        payload = ApplicationCreate(name=name, type=app_type, organization_id=str(org_id), app_owner_id=app_owner.id, description=description, is_active=True)
        response = await authenticated_test_client.post("/api/v1/applications/", json=payload.model_dump(mode='json'))
>       assert response.status_code == 201, f"Failed to create {name}: {response.text}"
E       AssertionError: Failed to create Alpha App: {"detail":"An unexpected error occurred while creating the application."}
E       assert 500 == 201
E        +  where 500 = <Response [500 Internal Server Error]>.status_code

backend/app/tests/api/test_applications_api.py:351: AssertionError
___________________________ test_update_application ____________________________

application_in = ApplicationCreate(name='Original App Name', description='Original Description', type=<ApplicationType.OWNED: 'Owned'>,...rganization_id=UUID('00000000-0000-0000-0000-000000000001'), app_owner_id=UUID('ee119007-21da-4b94-946c-2d4f4ca44a8b'))
db = <sqlalchemy.orm.session.AsyncSession object at 0x107e23310>
current_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.user@example.com')>

    @router.post("/", response_model=ApplicationResponse, status_code=status.HTTP_201_CREATED)
    async def create_application(
        application_in: ApplicationCreate,
        db: Annotated[AsyncSession, Depends(get_async_db)],
        current_user: Annotated[User, Depends(get_current_active_user)]
        # current_user: Annotated[User, Depends(require_admin)] # For RBAC
    ):
        """
        Create a new application within the current user's organization.
        Requires admin privileges.
        """
        try:
            # The service layer will validate if app_owner_id (if provided) belongs to the same organization.
>           created_application = await application_service.create_application(
                db=db,
                application_in=application_in,
                current_user=current_user # Corrected: pass current_user object
            )

backend/app/apis/endpoints/applications.py:29: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
backend/app/services/application_service.py:62: in create_application
    organization = (await db.execute(org_stmt)).scalar_one_or_none()
venv/lib/python3.9/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
venv/lib/python3.9/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1415: in execute
    return meth(
venv/lib/python3.9/site-packages/sqlalchemy/sql/elements.py:523: in _execute_on_connection
    return connection._execute_clauseelement(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1637: in _execute_clauseelement
    ret = self._execute_context(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1842: in _execute_context
    return self._exec_single_context(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1982: in _exec_single_context
    self._handle_dbapi_exception(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2354: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1963: in _exec_single_context
    self.dialect.do_execute(
venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py:943: in do_execute
    cursor.execute(statement, parameters)
venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py:97: in execute
    return self.await_(self._execute_async(operation, parameters))
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py:106: in _execute_async
    result = await self._cursor.execute(operation, parameters)
venv/lib/python3.9/site-packages/aiomysql/cursors.py:239: in execute
    await self._query(query)
venv/lib/python3.9/site-packages/aiomysql/cursors.py:457: in _query
    await conn.query(q)
venv/lib/python3.9/site-packages/aiomysql/connection.py:469: in query
    await self._read_query_result(unbuffered=unbuffered)
venv/lib/python3.9/site-packages/aiomysql/connection.py:683: in _read_query_result
    await result.read()
venv/lib/python3.9/site-packages/aiomysql/connection.py:1164: in read
    first_packet = await self.connection._read_packet()
venv/lib/python3.9/site-packages/aiomysql/connection.py:609: in _read_packet
    packet_header = await self._read_bytes(4)
venv/lib/python3.9/site-packages/aiomysql/connection.py:657: in _read_bytes
    data = await self._reader.readexactly(num_bytes)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:723: in readexactly
    await self._wait_for_data('readexactly')
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <StreamReader transport=<_SelectorSocketTransport closing fd=21>>
func_name = 'readexactly'

    async def _wait_for_data(self, func_name):
        """Wait until feed_data() or feed_eof() is called.
    
        If stream was paused, automatically resume it.
        """
        # StreamReader uses a future to link the protocol feed_data() method
        # to a read coroutine. Running two read coroutines at the same time
        # would have an unexpected behaviour. It would not possible to know
        # which coroutine would get the next data.
        if self._waiter is not None:
            raise RuntimeError(
                f'{func_name}() called while another coroutine is '
                f'already waiting for incoming data')
    
        assert not self._eof, '_wait_for_data after EOF'
    
        # Waiting for data while paused will make deadlock, so prevent it.
        # This is essential for readexactly(n) for case when n > self._limit.
        if self._paused:
            self._paused = False
            self._transport.resume_reading()
    
        self._waiter = self._loop.create_future()
        try:
>           await self._waiter
E           RuntimeError: Task <Task pending name='Task-119' coro=<test_update_application() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:477> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop

/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:517: RuntimeError

During handling of the above exception, another exception occurred:

    async def get_async_db() -> Generator[AsyncSession, None, None]:
        async with AsyncSessionLocal() as session:
            try:
>               yield session

backend/app/apis/deps.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.9/site-packages/fastapi/routing.py:301: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.9/site-packages/fastapi/routing.py:212: in run_endpoint_function
    return await dependant.call(**values)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

application_in = ApplicationCreate(name='Original App Name', description='Original Description', type=<ApplicationType.OWNED: 'Owned'>,...rganization_id=UUID('00000000-0000-0000-0000-000000000001'), app_owner_id=UUID('ee119007-21da-4b94-946c-2d4f4ca44a8b'))
db = <sqlalchemy.orm.session.AsyncSession object at 0x107e23310>
current_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.user@example.com')>

    @router.post("/", response_model=ApplicationResponse, status_code=status.HTTP_201_CREATED)
    async def create_application(
        application_in: ApplicationCreate,
        db: Annotated[AsyncSession, Depends(get_async_db)],
        current_user: Annotated[User, Depends(get_current_active_user)]
        # current_user: Annotated[User, Depends(require_admin)] # For RBAC
    ):
        """
        Create a new application within the current user's organization.
        Requires admin privileges.
        """
        try:
            # The service layer will validate if app_owner_id (if provided) belongs to the same organization.
            created_application = await application_service.create_application(
                db=db,
                application_in=application_in,
                current_user=current_user # Corrected: pass current_user object
            )
            return created_application
        except HTTPException as http_exc:
            raise http_exc # Re-raise HTTPException from service layer
        except ValueError as ve: # Catch specific validation errors if service raises them
            raise HTTPException(status_code=status.HTTP_422_UNPROCESSABLE_ENTITY, detail=str(ve))
        except Exception as e:
            # TODO: Log the exception e
            print(f"Unexpected error in create_application: {e}") # Temporary print
>           raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="An unexpected error occurred while creating the application.")
E           fastapi.exceptions.HTTPException: 500: An unexpected error occurred while creating the application.

backend/app/apis/endpoints/applications.py:42: HTTPException

During handling of the above exception, another exception occurred:

authenticated_test_client = <httpx.AsyncClient object at 0x106d92820>
db_session = <sqlalchemy.orm.session.Session object at 0x106acfc40>
current_test_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.async.user@example.com')>

    @pytest.mark.asyncio
    async def test_update_application(authenticated_test_client: AsyncClient, db_session: AsyncSession, current_test_user: UserModel):
        org_id = current_test_user.organization_id
        owner_orig = create_test_user(db_session, organization_id=org_id, first_name_prefix="OwnerOrigUpd")
        owner_new = create_test_user(db_session, organization_id=org_id, first_name_prefix="OwnerNewUpd")
    
        app_create_payload = ApplicationCreate(
            name="Original App Name",
            type=ApplicationType.OWNED.value,
            organization_id=str(org_id),
            is_active=True,
            app_owner_id=owner_orig.id,
            description="Original Description",
            criticality="Medium",
            status="ACTIVE" # Assuming status is a simple string, or use ApplicationStatusEnum.ACTIVE.value
        )
>       create_response = await authenticated_test_client.post("/api/v1/applications/", json=app_create_payload.model_dump(mode='json'))

backend/app/tests/api/test_applications_api.py:477: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.9/site-packages/httpx/_client.py:1859: in post
    return await self.request(
venv/lib/python3.9/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
venv/lib/python3.9/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
venv/lib/python3.9/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
venv/lib/python3.9/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
venv/lib/python3.9/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
venv/lib/python3.9/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
venv/lib/python3.9/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
venv/lib/python3.9/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.9/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.9/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.9/site-packages/starlette/routing.py:73: in app
    response = await f(request)
venv/lib/python3.9/site-packages/fastapi/routing.py:341: in app
    response.headers.raw.extend(solved_result.response.headers.raw)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py:651: in __aexit__
    raise exc_details[1]
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py:634: in __aexit__
    cb_suppress = await cb(*exc_details)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py:193: in __aexit__
    await self.gen.athrow(typ, value, traceback)
backend/app/apis/deps.py:77: in get_async_db
    await session.rollback()
venv/lib/python3.9/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:1395: in rollback
    raise rollback_err[1].with_traceback(rollback_err[2])
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:1360: in rollback
    t[1].rollback()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2607: in rollback
    self._do_rollback()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2726: in _do_rollback
    self._close_impl(try_deactivate=True)
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2709: in _close_impl
    self._connection_rollback_impl()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2701: in _connection_rollback_impl
    self.connection._rollback_impl()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1126: in _rollback_impl
    self._handle_dbapi_exception(e, None, None, None, None)
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2354: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1124: in _rollback_impl
    self.engine.dialect.do_rollback(self.connection)
venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py:703: in do_rollback
    dbapi_connection.rollback()
venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py:203: in rollback
    self.await_(self._connection.rollback())
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.9/site-packages/aiomysql/connection.py:399: in rollback
    await self._read_ok_packet()
venv/lib/python3.9/site-packages/aiomysql/connection.py:372: in _read_ok_packet
    pkt = await self._read_packet()
venv/lib/python3.9/site-packages/aiomysql/connection.py:609: in _read_packet
    packet_header = await self._read_bytes(4)
venv/lib/python3.9/site-packages/aiomysql/connection.py:657: in _read_bytes
    data = await self._reader.readexactly(num_bytes)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:723: in readexactly
    await self._wait_for_data('readexactly')
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <StreamReader transport=<_SelectorSocketTransport closing fd=21>>
func_name = 'readexactly'

    async def _wait_for_data(self, func_name):
        """Wait until feed_data() or feed_eof() is called.
    
        If stream was paused, automatically resume it.
        """
        # StreamReader uses a future to link the protocol feed_data() method
        # to a read coroutine. Running two read coroutines at the same time
        # would have an unexpected behaviour. It would not possible to know
        # which coroutine would get the next data.
        if self._waiter is not None:
            raise RuntimeError(
                f'{func_name}() called while another coroutine is '
                f'already waiting for incoming data')
    
        assert not self._eof, '_wait_for_data after EOF'
    
        # Waiting for data while paused will make deadlock, so prevent it.
        # This is essential for readexactly(n) for case when n > self._limit.
        if self._paused:
            self._paused = False
            self._transport.resume_reading()
    
        self._waiter = self._loop.create_future()
        try:
>           await self._waiter
E           RuntimeError: Task <Task pending name='Task-119' coro=<test_update_application() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:477> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop

/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:517: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:1009 Exception during reset or similar
Traceback (most recent call last):
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 987, in _finalize_fairy
    fairy._reset(
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 1433, in _reset
    pool._dialect.do_rollback(self)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py", line 703, in do_rollback
    dbapi_connection.rollback()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 203, in rollback
    self.await_(self._connection.rollback())
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 399, in rollback
    await self._read_ok_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 372, in _read_ok_packet
    pkt = await self._read_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 609, in _read_packet
    packet_header = await self._read_bytes(4)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 657, in _read_bytes
    data = await self._reader.readexactly(num_bytes)
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 723, in readexactly
    await self._wait_for_data('readexactly')
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 517, in _wait_for_data
    await self._waiter
RuntimeError: Task <Task pending name='Task-119' coro=<test_update_application() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:477> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:378 Exception terminating connection <AdaptedConnection <aiomysql.connection.Connection object at 0x107e28760>>
Traceback (most recent call last):
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 987, in _finalize_fairy
    fairy._reset(
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 1433, in _reset
    pool._dialect.do_rollback(self)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py", line 703, in do_rollback
    dbapi_connection.rollback()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 203, in rollback
    self.await_(self._connection.rollback())
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 399, in rollback
    await self._read_ok_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 372, in _read_ok_packet
    pkt = await self._read_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 609, in _read_packet
    packet_header = await self._read_bytes(4)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 657, in _read_bytes
    data = await self._reader.readexactly(num_bytes)
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 723, in readexactly
    await self._wait_for_data('readexactly')
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 517, in _wait_for_data
    await self._waiter
RuntimeError: Task <Task pending name='Task-119' coro=<test_update_application() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:477> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 374, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 312, in do_terminate
    dbapi_connection.terminate()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 210, in terminate
    self._connection.close()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 339, in close
    self._writer.transport.close()
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/selector_events.py", line 700, in close
    self._loop.call_soon(self._call_connection_lost, None)
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py", line 746, in call_soon
    self._check_closed()
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py", line 510, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
______________________ test_update_application_not_found _______________________

authenticated_test_client = <httpx.AsyncClient object at 0x10879a100>
current_test_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.async.user@example.com')>

    @pytest.mark.asyncio
    async def test_update_application_not_found(authenticated_test_client: AsyncClient, current_test_user: UserModel):
        non_existent_app_id = uuid.uuid4()
        update_payload = ApplicationUpdate(name="Attempted Update To NonExistent")
        response = await authenticated_test_client.put(f"/api/v1/applications/{non_existent_app_id}", json=update_payload.model_dump(mode='json', exclude_unset=True))
>       assert response.status_code == 404, response.text
E       AssertionError: {"detail":"An unexpected error occurred while updating the application."}
E       assert 500 == 404
E        +  where 500 = <Response [500 Internal Server Error]>.status_code

backend/app/tests/api/test_applications_api.py:509: AssertionError
____________________ test_update_application_invalid_owner _____________________

application_in = ApplicationCreate(name='App For Invalid Owner Update Test', description=None, type=<ApplicationType.OWNED: 'Owned'>, h...rganization_id=UUID('00000000-0000-0000-0000-000000000001'), app_owner_id=UUID('4cd6d59a-09c4-4ff6-96f7-030a87d50615'))
db = <sqlalchemy.orm.session.AsyncSession object at 0x107b722e0>
current_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.user@example.com')>

    @router.post("/", response_model=ApplicationResponse, status_code=status.HTTP_201_CREATED)
    async def create_application(
        application_in: ApplicationCreate,
        db: Annotated[AsyncSession, Depends(get_async_db)],
        current_user: Annotated[User, Depends(get_current_active_user)]
        # current_user: Annotated[User, Depends(require_admin)] # For RBAC
    ):
        """
        Create a new application within the current user's organization.
        Requires admin privileges.
        """
        try:
            # The service layer will validate if app_owner_id (if provided) belongs to the same organization.
>           created_application = await application_service.create_application(
                db=db,
                application_in=application_in,
                current_user=current_user # Corrected: pass current_user object
            )

backend/app/apis/endpoints/applications.py:29: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
backend/app/services/application_service.py:62: in create_application
    organization = (await db.execute(org_stmt)).scalar_one_or_none()
venv/lib/python3.9/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
venv/lib/python3.9/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1415: in execute
    return meth(
venv/lib/python3.9/site-packages/sqlalchemy/sql/elements.py:523: in _execute_on_connection
    return connection._execute_clauseelement(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1637: in _execute_clauseelement
    ret = self._execute_context(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1842: in _execute_context
    return self._exec_single_context(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1982: in _exec_single_context
    self._handle_dbapi_exception(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2354: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1963: in _exec_single_context
    self.dialect.do_execute(
venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py:943: in do_execute
    cursor.execute(statement, parameters)
venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py:97: in execute
    return self.await_(self._execute_async(operation, parameters))
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py:106: in _execute_async
    result = await self._cursor.execute(operation, parameters)
venv/lib/python3.9/site-packages/aiomysql/cursors.py:239: in execute
    await self._query(query)
venv/lib/python3.9/site-packages/aiomysql/cursors.py:457: in _query
    await conn.query(q)
venv/lib/python3.9/site-packages/aiomysql/connection.py:469: in query
    await self._read_query_result(unbuffered=unbuffered)
venv/lib/python3.9/site-packages/aiomysql/connection.py:683: in _read_query_result
    await result.read()
venv/lib/python3.9/site-packages/aiomysql/connection.py:1164: in read
    first_packet = await self.connection._read_packet()
venv/lib/python3.9/site-packages/aiomysql/connection.py:609: in _read_packet
    packet_header = await self._read_bytes(4)
venv/lib/python3.9/site-packages/aiomysql/connection.py:657: in _read_bytes
    data = await self._reader.readexactly(num_bytes)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:723: in readexactly
    await self._wait_for_data('readexactly')
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <StreamReader transport=<_SelectorSocketTransport closing fd=22>>
func_name = 'readexactly'

    async def _wait_for_data(self, func_name):
        """Wait until feed_data() or feed_eof() is called.
    
        If stream was paused, automatically resume it.
        """
        # StreamReader uses a future to link the protocol feed_data() method
        # to a read coroutine. Running two read coroutines at the same time
        # would have an unexpected behaviour. It would not possible to know
        # which coroutine would get the next data.
        if self._waiter is not None:
            raise RuntimeError(
                f'{func_name}() called while another coroutine is '
                f'already waiting for incoming data')
    
        assert not self._eof, '_wait_for_data after EOF'
    
        # Waiting for data while paused will make deadlock, so prevent it.
        # This is essential for readexactly(n) for case when n > self._limit.
        if self._paused:
            self._paused = False
            self._transport.resume_reading()
    
        self._waiter = self._loop.create_future()
        try:
>           await self._waiter
E           RuntimeError: Task <Task pending name='Task-144' coro=<test_update_application_invalid_owner() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:525> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop

/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:517: RuntimeError

During handling of the above exception, another exception occurred:

    async def get_async_db() -> Generator[AsyncSession, None, None]:
        async with AsyncSessionLocal() as session:
            try:
>               yield session

backend/app/apis/deps.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.9/site-packages/fastapi/routing.py:301: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.9/site-packages/fastapi/routing.py:212: in run_endpoint_function
    return await dependant.call(**values)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

application_in = ApplicationCreate(name='App For Invalid Owner Update Test', description=None, type=<ApplicationType.OWNED: 'Owned'>, h...rganization_id=UUID('00000000-0000-0000-0000-000000000001'), app_owner_id=UUID('4cd6d59a-09c4-4ff6-96f7-030a87d50615'))
db = <sqlalchemy.orm.session.AsyncSession object at 0x107b722e0>
current_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.user@example.com')>

    @router.post("/", response_model=ApplicationResponse, status_code=status.HTTP_201_CREATED)
    async def create_application(
        application_in: ApplicationCreate,
        db: Annotated[AsyncSession, Depends(get_async_db)],
        current_user: Annotated[User, Depends(get_current_active_user)]
        # current_user: Annotated[User, Depends(require_admin)] # For RBAC
    ):
        """
        Create a new application within the current user's organization.
        Requires admin privileges.
        """
        try:
            # The service layer will validate if app_owner_id (if provided) belongs to the same organization.
            created_application = await application_service.create_application(
                db=db,
                application_in=application_in,
                current_user=current_user # Corrected: pass current_user object
            )
            return created_application
        except HTTPException as http_exc:
            raise http_exc # Re-raise HTTPException from service layer
        except ValueError as ve: # Catch specific validation errors if service raises them
            raise HTTPException(status_code=status.HTTP_422_UNPROCESSABLE_ENTITY, detail=str(ve))
        except Exception as e:
            # TODO: Log the exception e
            print(f"Unexpected error in create_application: {e}") # Temporary print
>           raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="An unexpected error occurred while creating the application.")
E           fastapi.exceptions.HTTPException: 500: An unexpected error occurred while creating the application.

backend/app/apis/endpoints/applications.py:42: HTTPException

During handling of the above exception, another exception occurred:

authenticated_test_client = <httpx.AsyncClient object at 0x108487d00>
db_session = <sqlalchemy.orm.session.Session object at 0x108472280>
current_test_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.async.user@example.com')>

    @pytest.mark.asyncio
    async def test_update_application_invalid_owner(authenticated_test_client: AsyncClient, db_session: AsyncSession, current_test_user: UserModel):
        org_id = current_test_user.organization_id
        initial_owner = create_test_user(db_session, organization_id=org_id, first_name_prefix="InitialAppOwner")
    
        app_create_payload = ApplicationCreate(
            name="App For Invalid Owner Update Test",
            type=ApplicationType.OWNED.value,
            organization_id=str(org_id),
            is_active=True,
            app_owner_id=initial_owner.id,
            status="ACTIVE"
        )
>       create_response = await authenticated_test_client.post("/api/v1/applications/", json=app_create_payload.model_dump(mode='json'))

backend/app/tests/api/test_applications_api.py:525: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.9/site-packages/httpx/_client.py:1859: in post
    return await self.request(
venv/lib/python3.9/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
venv/lib/python3.9/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
venv/lib/python3.9/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
venv/lib/python3.9/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
venv/lib/python3.9/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
venv/lib/python3.9/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
venv/lib/python3.9/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
venv/lib/python3.9/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.9/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.9/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.9/site-packages/starlette/routing.py:73: in app
    response = await f(request)
venv/lib/python3.9/site-packages/fastapi/routing.py:341: in app
    response.headers.raw.extend(solved_result.response.headers.raw)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py:651: in __aexit__
    raise exc_details[1]
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py:634: in __aexit__
    cb_suppress = await cb(*exc_details)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py:193: in __aexit__
    await self.gen.athrow(typ, value, traceback)
backend/app/apis/deps.py:77: in get_async_db
    await session.rollback()
venv/lib/python3.9/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:1395: in rollback
    raise rollback_err[1].with_traceback(rollback_err[2])
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:1360: in rollback
    t[1].rollback()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2607: in rollback
    self._do_rollback()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2726: in _do_rollback
    self._close_impl(try_deactivate=True)
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2709: in _close_impl
    self._connection_rollback_impl()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2701: in _connection_rollback_impl
    self.connection._rollback_impl()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1126: in _rollback_impl
    self._handle_dbapi_exception(e, None, None, None, None)
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2354: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1124: in _rollback_impl
    self.engine.dialect.do_rollback(self.connection)
venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py:703: in do_rollback
    dbapi_connection.rollback()
venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py:203: in rollback
    self.await_(self._connection.rollback())
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.9/site-packages/aiomysql/connection.py:399: in rollback
    await self._read_ok_packet()
venv/lib/python3.9/site-packages/aiomysql/connection.py:372: in _read_ok_packet
    pkt = await self._read_packet()
venv/lib/python3.9/site-packages/aiomysql/connection.py:609: in _read_packet
    packet_header = await self._read_bytes(4)
venv/lib/python3.9/site-packages/aiomysql/connection.py:657: in _read_bytes
    data = await self._reader.readexactly(num_bytes)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:723: in readexactly
    await self._wait_for_data('readexactly')
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <StreamReader transport=<_SelectorSocketTransport closing fd=22>>
func_name = 'readexactly'

    async def _wait_for_data(self, func_name):
        """Wait until feed_data() or feed_eof() is called.
    
        If stream was paused, automatically resume it.
        """
        # StreamReader uses a future to link the protocol feed_data() method
        # to a read coroutine. Running two read coroutines at the same time
        # would have an unexpected behaviour. It would not possible to know
        # which coroutine would get the next data.
        if self._waiter is not None:
            raise RuntimeError(
                f'{func_name}() called while another coroutine is '
                f'already waiting for incoming data')
    
        assert not self._eof, '_wait_for_data after EOF'
    
        # Waiting for data while paused will make deadlock, so prevent it.
        # This is essential for readexactly(n) for case when n > self._limit.
        if self._paused:
            self._paused = False
            self._transport.resume_reading()
    
        self._waiter = self._loop.create_future()
        try:
>           await self._waiter
E           RuntimeError: Task <Task pending name='Task-144' coro=<test_update_application_invalid_owner() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:525> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop

/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:517: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:1009 Exception during reset or similar
Traceback (most recent call last):
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 987, in _finalize_fairy
    fairy._reset(
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 1433, in _reset
    pool._dialect.do_rollback(self)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py", line 703, in do_rollback
    dbapi_connection.rollback()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 203, in rollback
    self.await_(self._connection.rollback())
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 399, in rollback
    await self._read_ok_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 372, in _read_ok_packet
    pkt = await self._read_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 609, in _read_packet
    packet_header = await self._read_bytes(4)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 657, in _read_bytes
    data = await self._reader.readexactly(num_bytes)
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 723, in readexactly
    await self._wait_for_data('readexactly')
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 517, in _wait_for_data
    await self._waiter
RuntimeError: Task <Task pending name='Task-144' coro=<test_update_application_invalid_owner() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:525> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:378 Exception terminating connection <AdaptedConnection <aiomysql.connection.Connection object at 0x107dc7be0>>
Traceback (most recent call last):
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 987, in _finalize_fairy
    fairy._reset(
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 1433, in _reset
    pool._dialect.do_rollback(self)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py", line 703, in do_rollback
    dbapi_connection.rollback()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 203, in rollback
    self.await_(self._connection.rollback())
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 399, in rollback
    await self._read_ok_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 372, in _read_ok_packet
    pkt = await self._read_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 609, in _read_packet
    packet_header = await self._read_bytes(4)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 657, in _read_bytes
    data = await self._reader.readexactly(num_bytes)
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 723, in readexactly
    await self._wait_for_data('readexactly')
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 517, in _wait_for_data
    await self._waiter
RuntimeError: Task <Task pending name='Task-144' coro=<test_update_application_invalid_owner() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:525> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 374, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 312, in do_terminate
    dbapi_connection.terminate()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 210, in terminate
    self._connection.close()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 339, in close
    self._writer.transport.close()
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/selector_events.py", line 700, in close
    self._loop.call_soon(self._call_connection_lost, None)
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py", line 746, in call_soon
    self._check_closed()
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py", line 510, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
___________________________ test_delete_application ____________________________

authenticated_test_client = <httpx.AsyncClient object at 0x10843b250>
async_db_session = <sqlalchemy.ext.asyncio.session.AsyncSession object at 0x10814b310>
current_test_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.async.user@example.com')>

    @pytest.mark.asyncio
    async def test_delete_application(authenticated_test_client: AsyncClient, async_db_session: AsyncSession, current_test_user: UserModel):
        org_id = current_test_user.organization_id
        app_owner = await create_test_user_async(async_db_session, organization_id=org_id, first_name_prefix="AppOwnerForDelete")
    
        app_create_payload = ApplicationCreate(
            name="App To Be Soft Deleted",
            type=ApplicationType.OWNED.value,
            organization_id=str(org_id),
            is_active=True,
            app_owner_id=app_owner.id,
            status="ACTIVE"
        )
        create_response = await authenticated_test_client.post("/api/v1/applications/", json=app_create_payload.model_dump(mode='json'))
>       assert create_response.status_code == 201, create_response.text
E       AssertionError: {"detail":"An unexpected error occurred while creating the application."}
E       assert 500 == 201
E        +  where 500 = <Response [500 Internal Server Error]>.status_code

backend/app/tests/api/test_applications_api.py:567: AssertionError
______________________ test_delete_application_not_found _______________________

application_id = UUID('7c9dafdd-fb77-4d94-8f24-7cdc97903aa6')
db = <sqlalchemy.orm.session.AsyncSession object at 0x1069e0610>
current_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.user@example.com')>

    @router.delete("/{application_id}", response_model=ApplicationResponse)
    async def delete_application(
        application_id: uuid.UUID,
        db: Annotated[AsyncSession, Depends(get_async_db)],
        current_user: Annotated[User, Depends(get_current_active_user)]
        # current_user: Annotated[User, Depends(require_admin)] # For RBAC
    ):
        """
        Soft delete an application within the current user's organization.
        Requires admin privileges.
        """
        try:
            # The service method get_application (called internally by delete_application if it checks existence first)
            # or the delete_application method itself will handle not_found or already_deleted cases.
>           deleted_application = await application_service.delete_application(
                db=db,
                application_id=application_id,
                organization_id=current_user.organization_id
            )

backend/app/apis/endpoints/applications.py:124: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
backend/app/services/application_service.py:212: in delete_application
    db_application = await self.get_application_by_id(
backend/app/services/application_service.py:34: in get_application_by_id
    result = await db.execute(stmt)
venv/lib/python3.9/site-packages/sqlalchemy/ext/asyncio/session.py:463: in execute
    result = await greenlet_spawn(
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:201: in greenlet_spawn
    result = context.throw(*sys.exc_info())
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:2365: in execute
    return self._execute_internal(
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:2251: in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
venv/lib/python3.9/site-packages/sqlalchemy/orm/context.py:306: in orm_execute_statement
    result = conn.execute(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1415: in execute
    return meth(
venv/lib/python3.9/site-packages/sqlalchemy/sql/elements.py:523: in _execute_on_connection
    return connection._execute_clauseelement(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1637: in _execute_clauseelement
    ret = self._execute_context(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1842: in _execute_context
    return self._exec_single_context(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1982: in _exec_single_context
    self._handle_dbapi_exception(
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2354: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1963: in _exec_single_context
    self.dialect.do_execute(
venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py:943: in do_execute
    cursor.execute(statement, parameters)
venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py:97: in execute
    return self.await_(self._execute_async(operation, parameters))
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py:106: in _execute_async
    result = await self._cursor.execute(operation, parameters)
venv/lib/python3.9/site-packages/aiomysql/cursors.py:239: in execute
    await self._query(query)
venv/lib/python3.9/site-packages/aiomysql/cursors.py:457: in _query
    await conn.query(q)
venv/lib/python3.9/site-packages/aiomysql/connection.py:469: in query
    await self._read_query_result(unbuffered=unbuffered)
venv/lib/python3.9/site-packages/aiomysql/connection.py:683: in _read_query_result
    await result.read()
venv/lib/python3.9/site-packages/aiomysql/connection.py:1164: in read
    first_packet = await self.connection._read_packet()
venv/lib/python3.9/site-packages/aiomysql/connection.py:609: in _read_packet
    packet_header = await self._read_bytes(4)
venv/lib/python3.9/site-packages/aiomysql/connection.py:657: in _read_bytes
    data = await self._reader.readexactly(num_bytes)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:723: in readexactly
    await self._wait_for_data('readexactly')
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <StreamReader transport=<_SelectorSocketTransport closing fd=23>>
func_name = 'readexactly'

    async def _wait_for_data(self, func_name):
        """Wait until feed_data() or feed_eof() is called.
    
        If stream was paused, automatically resume it.
        """
        # StreamReader uses a future to link the protocol feed_data() method
        # to a read coroutine. Running two read coroutines at the same time
        # would have an unexpected behaviour. It would not possible to know
        # which coroutine would get the next data.
        if self._waiter is not None:
            raise RuntimeError(
                f'{func_name}() called while another coroutine is '
                f'already waiting for incoming data')
    
        assert not self._eof, '_wait_for_data after EOF'
    
        # Waiting for data while paused will make deadlock, so prevent it.
        # This is essential for readexactly(n) for case when n > self._limit.
        if self._paused:
            self._paused = False
            self._transport.resume_reading()
    
        self._waiter = self._loop.create_future()
        try:
>           await self._waiter
E           RuntimeError: Task <Task pending name='Task-169' coro=<test_delete_application_not_found() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:597> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop

/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:517: RuntimeError

During handling of the above exception, another exception occurred:

    async def get_async_db() -> Generator[AsyncSession, None, None]:
        async with AsyncSessionLocal() as session:
            try:
>               yield session

backend/app/apis/deps.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.9/site-packages/fastapi/routing.py:301: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.9/site-packages/fastapi/routing.py:212: in run_endpoint_function
    return await dependant.call(**values)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

application_id = UUID('7c9dafdd-fb77-4d94-8f24-7cdc97903aa6')
db = <sqlalchemy.orm.session.AsyncSession object at 0x1069e0610>
current_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.user@example.com')>

    @router.delete("/{application_id}", response_model=ApplicationResponse)
    async def delete_application(
        application_id: uuid.UUID,
        db: Annotated[AsyncSession, Depends(get_async_db)],
        current_user: Annotated[User, Depends(get_current_active_user)]
        # current_user: Annotated[User, Depends(require_admin)] # For RBAC
    ):
        """
        Soft delete an application within the current user's organization.
        Requires admin privileges.
        """
        try:
            # The service method get_application (called internally by delete_application if it checks existence first)
            # or the delete_application method itself will handle not_found or already_deleted cases.
            deleted_application = await application_service.delete_application(
                db=db,
                application_id=application_id,
                organization_id=current_user.organization_id
            )
            # The service now returns the soft-deleted application object or raises HTTPException for not found.
            return deleted_application
        except HTTPException as http_exc:
            raise http_exc # Re-raise HTTPException from service layer
        except ValueError as ve: # Should ideally be handled by service layer raising HTTPException
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=str(ve))
        except Exception as e:
            # TODO: Log the exception e
            print(f"Unexpected error in delete_application: {e}") # Temporary print
>           raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="An unexpected error occurred during deletion.")
E           fastapi.exceptions.HTTPException: 500: An unexpected error occurred during deletion.

backend/app/apis/endpoints/applications.py:138: HTTPException

During handling of the above exception, another exception occurred:

authenticated_test_client = <httpx.AsyncClient object at 0x10814bee0>
current_test_user = <User(id=00000000-0000-0000-0000-000000000002, email='default.async.user@example.com')>

    @pytest.mark.asyncio
    async def test_delete_application_not_found(authenticated_test_client: AsyncClient, current_test_user: UserModel):
        non_existent_app_id = uuid.uuid4()
>       response = await authenticated_test_client.delete(f"/api/v1/applications/{non_existent_app_id}")

backend/app/tests/api/test_applications_api.py:597: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.9/site-packages/httpx/_client.py:1966: in delete
    return await self.request(
venv/lib/python3.9/site-packages/httpx/_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
venv/lib/python3.9/site-packages/httpx/_client.py:1629: in send
    response = await self._send_handling_auth(
venv/lib/python3.9/site-packages/httpx/_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
venv/lib/python3.9/site-packages/httpx/_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
venv/lib/python3.9/site-packages/httpx/_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
venv/lib/python3.9/site-packages/httpx/_transports/asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
venv/lib/python3.9/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/middleware/errors.py:187: in __call__
    raise exc
venv/lib/python3.9/site-packages/starlette/middleware/errors.py:165: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.9/site-packages/starlette/middleware/cors.py:85: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/middleware/exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.9/site-packages/starlette/routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/routing.py:734: in app
    await route.handle(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/routing.py:288: in handle
    await self.app(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:53: in wrapped_app
    raise exc
venv/lib/python3.9/site-packages/starlette/_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv/lib/python3.9/site-packages/starlette/routing.py:73: in app
    response = await f(request)
venv/lib/python3.9/site-packages/fastapi/routing.py:341: in app
    response.headers.raw.extend(solved_result.response.headers.raw)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py:651: in __aexit__
    raise exc_details[1]
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py:634: in __aexit__
    cb_suppress = await cb(*exc_details)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/contextlib.py:193: in __aexit__
    await self.gen.athrow(typ, value, traceback)
backend/app/apis/deps.py:77: in get_async_db
    await session.rollback()
venv/lib/python3.9/site-packages/sqlalchemy/orm/state_changes.py:139: in _go
    ret_value = fn(self, *arg, **kw)
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:1395: in rollback
    raise rollback_err[1].with_traceback(rollback_err[2])
venv/lib/python3.9/site-packages/sqlalchemy/orm/session.py:1360: in rollback
    t[1].rollback()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2607: in rollback
    self._do_rollback()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2726: in _do_rollback
    self._close_impl(try_deactivate=True)
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2709: in _close_impl
    self._connection_rollback_impl()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2701: in _connection_rollback_impl
    self.connection._rollback_impl()
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1126: in _rollback_impl
    self._handle_dbapi_exception(e, None, None, None, None)
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:2354: in _handle_dbapi_exception
    raise exc_info[1].with_traceback(exc_info[2])
venv/lib/python3.9/site-packages/sqlalchemy/engine/base.py:1124: in _rollback_impl
    self.engine.dialect.do_rollback(self.connection)
venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py:703: in do_rollback
    dbapi_connection.rollback()
venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py:203: in rollback
    self.await_(self._connection.rollback())
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
venv/lib/python3.9/site-packages/aiomysql/connection.py:399: in rollback
    await self._read_ok_packet()
venv/lib/python3.9/site-packages/aiomysql/connection.py:372: in _read_ok_packet
    pkt = await self._read_packet()
venv/lib/python3.9/site-packages/aiomysql/connection.py:609: in _read_packet
    packet_header = await self._read_bytes(4)
venv/lib/python3.9/site-packages/aiomysql/connection.py:657: in _read_bytes
    data = await self._reader.readexactly(num_bytes)
/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:723: in readexactly
    await self._wait_for_data('readexactly')
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <StreamReader transport=<_SelectorSocketTransport closing fd=23>>
func_name = 'readexactly'

    async def _wait_for_data(self, func_name):
        """Wait until feed_data() or feed_eof() is called.
    
        If stream was paused, automatically resume it.
        """
        # StreamReader uses a future to link the protocol feed_data() method
        # to a read coroutine. Running two read coroutines at the same time
        # would have an unexpected behaviour. It would not possible to know
        # which coroutine would get the next data.
        if self._waiter is not None:
            raise RuntimeError(
                f'{func_name}() called while another coroutine is '
                f'already waiting for incoming data')
    
        assert not self._eof, '_wait_for_data after EOF'
    
        # Waiting for data while paused will make deadlock, so prevent it.
        # This is essential for readexactly(n) for case when n > self._limit.
        if self._paused:
            self._paused = False
            self._transport.resume_reading()
    
        self._waiter = self._loop.create_future()
        try:
>           await self._waiter
E           RuntimeError: Task <Task pending name='Task-169' coro=<test_delete_application_not_found() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:597> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop

/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py:517: RuntimeError
------------------------------ Captured log call -------------------------------
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:1009 Exception during reset or similar
Traceback (most recent call last):
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 987, in _finalize_fairy
    fairy._reset(
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 1433, in _reset
    pool._dialect.do_rollback(self)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py", line 703, in do_rollback
    dbapi_connection.rollback()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 203, in rollback
    self.await_(self._connection.rollback())
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 399, in rollback
    await self._read_ok_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 372, in _read_ok_packet
    pkt = await self._read_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 609, in _read_packet
    packet_header = await self._read_bytes(4)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 657, in _read_bytes
    data = await self._reader.readexactly(num_bytes)
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 723, in readexactly
    await self._wait_for_data('readexactly')
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 517, in _wait_for_data
    await self._waiter
RuntimeError: Task <Task pending name='Task-169' coro=<test_delete_application_not_found() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:597> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop
ERROR    sqlalchemy.pool.impl.AsyncAdaptedQueuePool:base.py:378 Exception terminating connection <AdaptedConnection <aiomysql.connection.Connection object at 0x1067ef5b0>>
Traceback (most recent call last):
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 987, in _finalize_fairy
    fairy._reset(
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 1433, in _reset
    pool._dialect.do_rollback(self)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/engine/default.py", line 703, in do_rollback
    dbapi_connection.rollback()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 203, in rollback
    self.await_(self._connection.rollback())
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 399, in rollback
    await self._read_ok_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 372, in _read_ok_packet
    pkt = await self._read_packet()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 609, in _read_packet
    packet_header = await self._read_bytes(4)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 657, in _read_bytes
    data = await self._reader.readexactly(num_bytes)
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 723, in readexactly
    await self._wait_for_data('readexactly')
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/streams.py", line 517, in _wait_for_data
    await self._waiter
RuntimeError: Task <Task pending name='Task-169' coro=<test_delete_application_not_found() running at /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/api/test_applications_api.py:597> cb=[_run_until_complete_cb() at /Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py:184, WorkerThread.stop()]> got Future <Future pending> attached to a different loop

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/pool/base.py", line 374, in _close_connection
    self._dialect.do_terminate(connection)
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 312, in do_terminate
    dbapi_connection.terminate()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/sqlalchemy/dialects/mysql/aiomysql.py", line 210, in terminate
    self._connection.close()
  File "/Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/aiomysql/connection.py", line 339, in close
    self._writer.transport.close()
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/selector_events.py", line 700, in close
    self._loop.call_soon(self._call_connection_lost, None)
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py", line 746, in call_soon
    self._check_closed()
  File "/Library/Developer/CommandLineTools/Library/Frameworks/Python3.framework/Versions/3.9/lib/python3.9/asyncio/base_events.py", line 510, in _check_closed
    raise RuntimeError('Event loop is closed')
RuntimeError: Event loop is closed
___________________ test_delete_already_deleted_application ____________________

authenticated_test_client = <httpx.AsyncClient object at 0x10898ca00>
db_session = <sqlalchemy.orm.session.Session object at 0x106962070>

    @pytest.mark.asyncio
    async def test_delete_already_deleted_application(authenticated_test_client: AsyncClient, db_session: Session):
        org = create_test_organization(db_session, name="AppDeleteTwice Org2")
        org_id = org.id
        if org in db_session: db_session.expunge(org)
    
        app_create_data = ApplicationCreate(name="App To Be Deleted Twice Again", organization_id=str(org_id), type=ApplicationType.SAAS.value, is_active=True)
        create_response = await authenticated_test_client.post("/api/v1/applications/", content=app_create_data.model_dump_json(), headers={"Content-Type": "application/json"})
>       assert create_response.status_code == 201, create_response.text
E       AssertionError: {"detail":"Organization with id aed39e9c-c1d7-4224-b98d-93ceae981c22 not found."}
E       assert 404 == 201
E        +  where 404 = <Response [404 Not Found]>.status_code

backend/app/tests/api/test_applications_api.py:677: AssertionError
=============================== warnings summary ===============================
backend/app/tests/api/test_applications_api.py::test_create_application
  /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/backend/app/tests/conftest.py:81: RuntimeWarning: coroutine 'create_test_tables_async.<locals>.do_inspect' was never awaited
    await conn.run_sync(do_inspect)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

backend/app/tests/api/test_applications_api.py::test_create_application
  /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/pytest_asyncio/plugin.py:723: PytestDeprecationWarning: asyncio test 'test_create_application' requested async @pytest.fixture 'override_get_async_db' in strict mode. You might want to use @pytest_asyncio.fixture or switch to auto mode. This will become an error in future versions of flake8-asyncio.
    warnings.warn(

backend/app/tests/api/test_applications_api.py::test_create_application_minimal_data
  /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/pytest_asyncio/plugin.py:723: PytestDeprecationWarning: asyncio test 'test_create_application_minimal_data' requested async @pytest.fixture 'override_get_async_db' in strict mode. You might want to use @pytest_asyncio.fixture or switch to auto mode. This will become an error in future versions of flake8-asyncio.
    warnings.warn(

backend/app/tests/api/test_applications_api.py::test_create_application_invalid_app_owner_id
  /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/pytest_asyncio/plugin.py:723: PytestDeprecationWarning: asyncio test 'test_create_application_invalid_app_owner_id' requested async @pytest.fixture 'override_get_async_db' in strict mode. You might want to use @pytest_asyncio.fixture or switch to auto mode. This will become an error in future versions of flake8-asyncio.
    warnings.warn(

backend/app/tests/api/test_applications_api.py::test_create_application_duplicate_name
  /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/pytest_asyncio/plugin.py:723: PytestDeprecationWarning: asyncio test 'test_create_application_duplicate_name' requested async @pytest.fixture 'override_get_async_db' in strict mode. You might want to use @pytest_asyncio.fixture or switch to auto mode. This will become an error in future versions of flake8-asyncio.
    warnings.warn(

backend/app/tests/api/test_applications_api.py::test_read_application
  /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/pytest_asyncio/plugin.py:723: PytestDeprecationWarning: asyncio test 'test_read_application' requested async @pytest.fixture 'override_get_async_db' in strict mode. You might want to use @pytest_asyncio.fixture or switch to auto mode. This will become an error in future versions of flake8-asyncio.
    warnings.warn(

backend/app/tests/api/test_applications_api.py::test_read_application_not_found
  /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/pytest_asyncio/plugin.py:723: PytestDeprecationWarning: asyncio test 'test_read_application_not_found' requested async @pytest.fixture 'override_get_async_db' in strict mode. You might want to use @pytest_asyncio.fixture or switch to auto mode. This will become an error in future versions of flake8-asyncio.
    warnings.warn(

backend/app/tests/api/test_applications_api.py::test_read_applications_empty
  /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/pytest_asyncio/plugin.py:723: PytestDeprecationWarning: asyncio test 'test_read_applications_empty' requested async @pytest.fixture 'override_get_async_db' in strict mode. You might want to use @pytest_asyncio.fixture or switch to auto mode. This will become an error in future versions of flake8-asyncio.
    warnings.warn(

backend/app/tests/api/test_applications_api.py::test_read_applications_list
  /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/pytest_asyncio/plugin.py:723: PytestDeprecationWarning: asyncio test 'test_read_applications_list' requested async @pytest.fixture 'override_get_async_db' in strict mode. You might want to use @pytest_asyncio.fixture or switch to auto mode. This will become an error in future versions of flake8-asyncio.
    warnings.warn(

backend/app/tests/api/test_applications_api.py::test_read_applications_pagination_and_filtering
  /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/pytest_asyncio/plugin.py:723: PytestDeprecationWarning: asyncio test 'test_read_applications_pagination_and_filtering' requested async @pytest.fixture 'override_get_async_db' in strict mode. You might want to use @pytest_asyncio.fixture or switch to auto mode. This will become an error in future versions of flake8-asyncio.
    warnings.warn(

backend/app/tests/api/test_applications_api.py::test_update_application
  /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/pytest_asyncio/plugin.py:723: PytestDeprecationWarning: asyncio test 'test_update_application' requested async @pytest.fixture 'override_get_async_db' in strict mode. You might want to use @pytest_asyncio.fixture or switch to auto mode. This will become an error in future versions of flake8-asyncio.
    warnings.warn(

backend/app/tests/api/test_applications_api.py::test_update_application_not_found
  /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/pytest_asyncio/plugin.py:723: PytestDeprecationWarning: asyncio test 'test_update_application_not_found' requested async @pytest.fixture 'override_get_async_db' in strict mode. You might want to use @pytest_asyncio.fixture or switch to auto mode. This will become an error in future versions of flake8-asyncio.
    warnings.warn(

backend/app/tests/api/test_applications_api.py::test_update_application_invalid_owner
  /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/pytest_asyncio/plugin.py:723: PytestDeprecationWarning: asyncio test 'test_update_application_invalid_owner' requested async @pytest.fixture 'override_get_async_db' in strict mode. You might want to use @pytest_asyncio.fixture or switch to auto mode. This will become an error in future versions of flake8-asyncio.
    warnings.warn(

backend/app/tests/api/test_applications_api.py::test_delete_application
  /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/pytest_asyncio/plugin.py:723: PytestDeprecationWarning: asyncio test 'test_delete_application' requested async @pytest.fixture 'override_get_async_db' in strict mode. You might want to use @pytest_asyncio.fixture or switch to auto mode. This will become an error in future versions of flake8-asyncio.
    warnings.warn(

backend/app/tests/api/test_applications_api.py::test_delete_application_not_found
  /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/pytest_asyncio/plugin.py:723: PytestDeprecationWarning: asyncio test 'test_delete_application_not_found' requested async @pytest.fixture 'override_get_async_db' in strict mode. You might want to use @pytest_asyncio.fixture or switch to auto mode. This will become an error in future versions of flake8-asyncio.
    warnings.warn(

backend/app/tests/api/test_applications_api.py::test_delete_already_deleted_application
  /Users/bharats/Library/CloudStorage/OneDrive-CYRAACSERVICESPRIVATELIMITED/Work/Product Management/Replit Projects/BCMS/Windsurf/venv/lib/python3.9/site-packages/pytest_asyncio/plugin.py:723: PytestDeprecationWarning: asyncio test 'test_delete_already_deleted_application' requested async @pytest.fixture 'override_get_async_db' in strict mode. You might want to use @pytest_asyncio.fixture or switch to auto mode. This will become an error in future versions of flake8-asyncio.
    warnings.warn(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED backend/app/tests/api/test_applications_api.py::test_create_application
FAILED backend/app/tests/api/test_applications_api.py::test_create_application_minimal_data
FAILED backend/app/tests/api/test_applications_api.py::test_create_application_invalid_app_owner_id
FAILED backend/app/tests/api/test_applications_api.py::test_create_application_duplicate_name
FAILED backend/app/tests/api/test_applications_api.py::test_read_application
FAILED backend/app/tests/api/test_applications_api.py::test_read_application_not_found
FAILED backend/app/tests/api/test_applications_api.py::test_read_applications_empty
FAILED backend/app/tests/api/test_applications_api.py::test_read_applications_list
FAILED backend/app/tests/api/test_applications_api.py::test_read_applications_pagination_and_filtering
FAILED backend/app/tests/api/test_applications_api.py::test_update_application
FAILED backend/app/tests/api/test_applications_api.py::test_update_application_not_found
FAILED backend/app/tests/api/test_applications_api.py::test_update_application_invalid_owner
FAILED backend/app/tests/api/test_applications_api.py::test_delete_application
FAILED backend/app/tests/api/test_applications_api.py::test_delete_application_not_found
FAILED backend/app/tests/api/test_applications_api.py::test_delete_already_deleted_application
ERROR backend/app/tests/api/test_applications_api.py::test_update_application_cross_organization_fail
ERROR backend/app/tests/api/test_applications_api.py::test_delete_application_cross_organization_fail
================== 15 failed, 16 warnings, 2 errors in 4.94s ===================
